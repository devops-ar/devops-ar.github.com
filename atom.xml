<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[devops-ar]]></title>
  <link href="http://devops-ar.github.com/atom.xml" rel="self"/>
  <link href="http://devops-ar.github.com/"/>
  <updated>2012-10-02T10:44:16-03:00</updated>
  <id>http://devops-ar.github.com/</id>
  <author>
    <name><![CDATA[osvaldo]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[deploying to aws]]></title>
    <link href="http://devops-ar.github.com/blog/2012/10/02/deploying-to-aws/"/>
    <updated>2012-10-02T09:31:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/10/02/deploying-to-aws</id>
    <content type="html"><![CDATA[<p>Amazon had done a great job making the cloud accesible to anyone. Tools like Chef (kudos to Opscode) allow us to make deployments in a pretty easy way. The following post will show how to put them together. A flask (could had been a lamp or any other) application is deployed to Amazon EC2 using Chef. As an added bonus, local development using Vagrant is included.</p>

<h2>tl;dr</h2>

<p>For those in a hurry, just clone the <a href="https://github.com/otsuarez/flask-blog">sample flask app code</a> and the <a href="https://github.com/otsuarez/flask2aws">chef cookbooks</a> repositories and start from there.</p>

<!-- more -->


<h1>Objective</h1>

<p>The original goal for this project was to deploy a group of servers in Amazon for a web based application (api rest interface). The architecture was designed with a load balancing web front end, an app server farm behind it and a third layer of database servers. This article only deals with a standalone server installation thus the cookbooks provide an extensible path for implementing the three-tiered application.</p>

<h1>Components</h1>

<h2>App code</h2>

<p>As a sample app, a simple blog using flask: <a href="https://bitbucket.org/r0sk/flask-htmlblog">FlaskBlog</a>  was choosed. No point on developing a full api/rest interface at this point. Code for this app can be found on this <a href="https://github.com/otsuarez/flask-blog">github repo</a>.</p>

<h2>Chef server</h2>

<p>A chef server was installed (details are not included) on a another host but a Hosted Chef Server might had done the job as well.</p>

<h2>Vagrant</h2>

<p>For testing the custom cookbooks, Vagrant was used on a local environment (<a href="https://github.com/otsuarez/flask2aws/blob/master/Vagrantfile">Vagrantfile</a> available).. The whole architecture could be testing this way since Vagrant allows us to create what it is called: &#8220;Multi-VM Environments&#8221;.</p>

<p>Cookbooks from Opscode repository were used (no point in reinventing the wheel). For handling the deploying and configuration, custom cookbooks were written.</p>

<h2>Opscode cookbooks (github.com/cookbooks/)</h2>

<ul>
<li>nginx</li>
<li>database</li>
<li>mysql (database cookbook dependency)</li>
<li>openssl (mysql cookbook dependency)</li>
</ul>


<h2>Custom cookbooks</h2>

<ul>
<li>appstack (takes care of code deployment, from the code repository to the proper directory on the filesystem)</li>
<li>webstack (handles all the configurations required for the app to work to be done across the whole app stack)</li>
<li>uwsgi (webstack cookbook dependency)</li>
</ul>


<p>The uwsgi cookbook only installs the uwsgi package. Since this package could be used by other cookbooks, it was created as an standalone cookbook.</p>

<h2>Deployment</h2>

<p>The appstack cookbook handles the deployment of the code. It creates the required directories and downloads the code from the repository. Github is used but any other could be used. Included keys (deploy) are only added for information purposes, those are not working ones.</p>

<p>Upon deployment, the webstack creates a database, importing the file &#8220;db/initial.sql&#8221; from the app code directory. The webstack cookbook creates the config.py file, which defines the database connection string for the app on the app code directory. It also creates the nginx virtual host file with the configuration for using the uwsgi service as the backend. The uwsgi.ini.erb template creates the corresponding uwsgi aplication file for the uwsgi service daemon to serve the app code.</p>

<h1>Chef workstation</h1>

<p>The whole setup requires 3 set of authentication credentials.</p>

<ul>
<li>github epo access</li>
<li>chef server</li>
<li>amazon aws</li>
</ul>


<h2>github</h2>

<p>The application code is stored on a github repository. A new (not any personal one) ssh key pair was created. The public key was added as a deploy key to the repo on github. The private key was added to the application deployment cookbook (appstack).</p>

<h2>chef server</h2>

<p>Using the chef server requires a client pem certificate which can be obtained via the Web console, creating a new client. That will allows you to work with the chef server from a workstation, using the knife command. For bootstrapping nodes, another credential is required, the validation.pem certificate. This one can be found on the /etc/chef/ directory of the chef server host filesystem.</p>

<h2>amazon ec2</h2>

<p>There&#8217;re two levels of access here. One is related to the ssh key used to log into the servers created on amazon. This key will be stored usually on the ~/.ssh directory of the workstation.</p>

<p>Create your SSH key pair for EC2 (at https://console.aws.amazon.com/ec2/home?#) and save your identity file on the local workstation (will be asumming you named the downloaded file acmeec2.pem)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> ~/.ssh
</span><span class='line'>mv ~/Downloads/acmeec2.pem .
</span><span class='line'>chmod 400 acmeec2.pem
</span><span class='line'>ssh-add ~/.ssh/acmeec2.pem
</span></code></pre></td></tr></table></div></figure>


<p>The other set of credentials are the ones used by the knife command for interacting with the AWS infrastructure. They are being used in the .chef/knife.rb file as env vars.
You need to add them to your ~/.bashrc or ~/.zshrc file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># EC2</span>
</span><span class='line'><span class="nb">export </span><span class="nv">acme_aws_access_key_id</span><span class="o">=</span><span class="s2">&quot;AZIAIGAI7VRAOZEBNAWA&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">acme_aws_secret_access_key</span><span class="o">=</span><span class="s2">&quot;ABJVqDRQm145Gmz+ee09MkqvINIuHs/wjEzaqdsN&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Working with the knife command</h2>

<p>creating the server</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife ec2 server create <span class="s2">&quot;role[webstack]&quot;</span> -I ami-3962a950  -x ubuntu --region eu-west-1
</span></code></pre></td></tr></table></div></figure>


<p>Checking the new server had been created and successfully added to the chef server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@local:~/src/acme/flask2aws<span class="nv">$ </span>knife ec2 server list
</span><span class='line'>Instance ID      Public IP        Private IP       Flavor           Image            SSH Key          Security Groups  State
</span><span class='line'>i-1f14ab82       174.129.142.100  10.28.59.8    m1.small         ami-3962a950     acmeec2    default          running
</span><span class='line'>osvaldo@local:~/src/acme/flask2aws<span class="nv">$ </span>knife node list
</span><span class='line'>  ip-10-28-59-8.ec2.internal
</span><span class='line'>  localhost
</span><span class='line'>osvaldo@local:~/src/acme/flask2aws<span class="nv">$ </span>
</span><span class='line'>osvaldo@otoja-lm:~/src/acme/flask2aws<span class="nv">$ </span>knife node show ip-10-28-59-8.ec2.internal
</span><span class='line'>Node Name:   ip-10-28-59-8.ec2.internal
</span><span class='line'>Environment: _default
</span><span class='line'>FQDN:        ip-10-28-59-8.ec2.internal
</span><span class='line'>IP:          174.129.142.100
</span><span class='line'>Run List:    role<span class="o">[</span>webstack<span class="o">]</span>
</span><span class='line'>Roles:       webstack
</span><span class='line'>Recipes:     webstack
</span><span class='line'>Platform:    ubuntu 11.10
</span><span class='line'>osvaldo@otoja-lm:~/src/acme/flask2aws<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>et voila!</p>

<p>Testing ssh connection to the amazon server and sudo privileges.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@local:~/src/acme/flask2aws<span class="nv">$ </span> ssh ubuntu@174.129.142.100 -i ~/.ssh/acmeec2.pem
</span><span class='line'>Welcome to Ubuntu 11.10 <span class="o">(</span>GNU/Linux 3.0.0-13-virtual i686<span class="o">)</span>
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>
</span><span class='line'>  System information as of Fri May 11 20:36:35 UTC 2012
</span><span class='line'>
</span><span class='line'>  System load:  0.0              Processes:           53
</span><span class='line'>  Usage of /:   8.9% of 9.84GB   Users logged in:     0
</span><span class='line'>  Memory usage: 10%              IP address <span class="k">for </span>eth0: 10.28.59.8
</span><span class='line'>  Swap usage:   0%
</span><span class='line'>
</span><span class='line'>  Graph this data and manage this system at https://landscape.canonical.com/
</span><span class='line'>New release <span class="s1">&#39;12.04 LTS&#39;</span> available.
</span><span class='line'>Run <span class="s1">&#39;do-release-upgrade&#39;</span> to upgrade to it.
</span><span class='line'>
</span><span class='line'>Get cloud support with Ubuntu Advantage Cloud Guest
</span><span class='line'>  http://www.ubuntu.com/business/services/cloud
</span><span class='line'>ubuntu@ip-10-28-59-8:~<span class="nv">$ </span>sudo su -
</span><span class='line'>root@ip-10-28-59-8:~#
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[usando svn push con jenkins]]></title>
    <link href="http://devops-ar.github.com/blog/2012/09/18/usando-svn-push-con-jenkins/"/>
    <updated>2012-09-18T12:23:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/09/18/usando-svn-push-con-jenkins</id>
    <content type="html"><![CDATA[<p>El jenkins puede ser configurado para que periodicamente chequee el repositorio (svn) y de haber algun nuevo commit lance un build.</p>

<p>Otra forma es que sea el subversion el que notifique al jenkins cuando se hizo un commit.</p>

<p>Para esto se modifica el hook post-commit del repositorio en svn.</p>

<figure class='code'><figcaption><span>/opt/svn/myproject/hooks/post-commit</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nv">REPOS</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class='line'><span class="nv">REV</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PYTHON_EGG_CACHE</span><span class="o">=</span>/opt/trac/.egg-cache
</span><span class='line'>
</span><span class='line'>/usr/bin/python /opt/svn/bin/svnhooks/trac-post-commit-hook -p <span class="s2">&quot;/opt/trac/myproject&quot;</span> -r <span class="s2">&quot;$REV&quot;</span>
</span><span class='line'>
</span><span class='line'>/usr/bin/svnnotify --max-sub-length 72 --max-diff-length 16384 --repos-path <span class="s2">&quot;$REPOS&quot;</span> --revision <span class="s2">&quot;$REV&quot;</span> --svnlook /usr/bin/svnlook --to myproject --with-diff --subject-cx --handler HTML::ColorDiff --subject-prefix <span class="s2">&quot;&quot;</span> --from myproject
</span><span class='line'>
</span><span class='line'><span class="nv">UUID</span><span class="o">=</span><span class="sb">`</span>/usr/bin/svnlook uuid <span class="nv">$REPOS</span><span class="sb">`</span>
</span><span class='line'><span class="nv">CISERVER</span><span class="o">=</span><span class="s2">&quot;http://jenkins.example.com/&quot;</span>
</span><span class='line'>
</span><span class='line'>/usr/bin/wget <span class="se">\</span>
</span><span class='line'>  --header <span class="s2">&quot;Content-Type:text/plain;charset=UTF-8&quot;</span> <span class="se">\</span>
</span><span class='line'>  --post-data <span class="s2">&quot;`svnlook changed --revision $REV $REPOS`&quot;</span> <span class="se">\</span>
</span><span class='line'>  --output-document <span class="s2">&quot;-&quot;</span> <span class="se">\</span>
</span><span class='line'>  --timeout<span class="o">=</span>2 <span class="se">\</span>
</span><span class='line'>  <span class="k">${</span><span class="nv">CISERVER</span><span class="p">=</span><span class="k">}</span>/subversion/<span class="k">${</span><span class="nv">UUID</span><span class="k">}</span>/notifyCommit?rev<span class="o">=</span><span class="nv">$REV</span>
</span></code></pre></td></tr></table></div></figure>


<p>Las primeras 9 lineas son las que crea el subversion de manera predeterminada. A partir de ahi estan las que realizan la notificacion al jenkins. En el <a href="http://jenkins-ci.org/content/subversion-repository-change-notification-push-vs-pull">sitio de jenkins sugieren este método</a> siempre que sea posible</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[definiendo un smarthost en mac os x]]></title>
    <link href="http://devops-ar.github.com/blog/2012/08/27/definiendo-un-smarthost-en-mac-os-x/"/>
    <updated>2012-08-27T11:36:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/08/27/definiendo-un-smarthost-en-mac-os-x</id>
    <content type="html"><![CDATA[<p>Es común tener un smarthost o relay de correo en las intranet. Si tenemos un equipo con Mac OS X  y necesitamos configurarle que todos los correos que envia salgan a través de un servidor en particular, estos serian los pasos. La pasarela de mensajeria seria para este caso: mailgateway.example.com. El puerto 25 en el smarthost deberia estar accesible desde el host que estamos configurando.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>postconf -e <span class="nv">relayhost</span><span class="o">=</span>mailgateway.example.com
</span><span class='line'>launchctl stop org.postfix.master
</span><span class='line'>launchctl unload /System/Library/LaunchDaemons/org.postfix.master.plist
</span><span class='line'>launchctl load /System/Library/LaunchDaemons/org.postfix.master.plist
</span><span class='line'>launchctl start org.postfix.master
</span></code></pre></td></tr></table></div></figure>


<p>Si se quiere comprobar utilizar los siguientes comandos.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;test&quot;</span> | mail -s <span class="s2">&quot;test&quot;</span> osvaldo@example.com
</span><span class='line'>tail -f /var/log/mail.log
</span></code></pre></td></tr></table></div></figure>


<p>Me guie por (este link)[http://thomer.com/howtos/postfix_smarthost_mailavenger.html] donde se explica además como configurar la autenticación si el smarthost lo requiere..</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[usando https detras de un proxy reverso]]></title>
    <link href="http://devops-ar.github.com/blog/2012/08/08/usando-https-detras-de-un-reverse-proxy/"/>
    <updated>2012-08-08T11:17:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/08/08/usando-https-detras-de-un-reverse-proxy</id>
    <content type="html"><![CDATA[<h2>tl;dr</h2>

<p>Agregar en el archivo .conf del apache para el sitio sin ssl:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='apacheconf'><span class='line'><span class="nb">RewriteEngine</span> <span class="k">On</span>
</span><span class='line'><span class="nb">RewriteCond</span> %{HTTP:X-Forwarded-Proto} !=https
</span><span class='line'><span class="nb">RewriteRule</span> (.*) https://%{SERVER_NAME}/$1 [redirect=permanent,last]
</span></code></pre></td></tr></table></div></figure>


<p>Con eso, deberia detectar que es http y hacer el redirect para el https. Ya el nginx le esta asignando esa variable (actuando como proxy reverso)</p>

<!-- more -->


<h2>En detalle</h2>

<p>Un proxy reverso es útil cuando queremos publicar sitios internos (generalmente de desarrollo) en internet. Estos sitios internos pueden estar en servidores independientes, sin embargo, todos ellos son publicados a través de un único server (IP) en internet: el proxy reverso.</p>

<p>Todo el tráfico web llega hasta el proxy reverso y de ahi se reenvía al servidor interno que le corresponda acorde al hostname de la URL.</p>

<p>Este esquema funciona para http pero para https tenemos el mismo problema de los virtualhosts. Hay que hacer que el proxy reverso sea el https endpoint para que pueda determinar el hostname del request y de ahi a que server interno le corresponde el pedido.</p>

<p>para tráfico http</p>

<pre><code>cliente -&gt; http -&gt; proxy reverso -&gt; http -&gt; server interno
</code></pre>

<p>para tráfico https</p>

<pre><code>cliente -&gt; https -&gt; proxy reverso -&gt; http -&gt; server interno
</code></pre>

<p>Eso funciona bien en la mayoria de los casos, pero que pasa si se quiere forzar el tráfico en un server para que sea solo https?
Si el cliente hace el pedido con http, el server interno recibe http.</p>

<pre><code>cliente -&gt; https -&gt; proxy reverso -&gt; http -&gt; server interno
</code></pre>

<p>El server interno detecta que no es https, y le responde al cliente con un rewrite de la url utilizando https. ¿Qué pasa entonces?</p>

<pre><code>cliente -&gt; http -&gt; proxy reverso -&gt; http -&gt; server interno
</code></pre>

<p>El server interno vuelve a recibir http y se crea un lazo infinito.</p>

<p>Pero no todos los servers necesitan que el tráfico sea solo https, algunos servers manejan servicios distintos por http y por https. Se necesita una solución que sea lo suficientemente genérica entonces.</p>

<p>La variante implementada consta de dos partes, una en el proxy reverso y otra en el server interno.</p>

<p>En el proxy reverso, cuando se recibe un request https, se setea una variable del HTTP header en el request que se le envia al servidor interno. Para los servidores que manejan por separado http y https, este header se ignora. En cambio, para los servidores que van a redireccionar todo el tráfico por https, en la sección de http del server web se comprueba la presencia de esta variable. Si esta, significa que el request llego via https y se procesa el request normalmente. Si no esta, se reenvia al cliente la URL redireccionada para usar https.</p>

<pre><code>cliente -&gt; http -&gt; proxy reverso -&gt; http -&gt; server interno  (RewriteRule (.*) https://%{SERVER_NAME}/$1 [redirect=permanent,last])
cliente -&gt; https -&gt; proxy reverso  -&gt; http (X-Forwarded-Proto https) -&gt; server interno
</code></pre>

<p>El proxy reverso utilizado es nginx y en el archivo de configuración (nginx.conf) se incluye lo siguiente:</p>

<figure class='code'><figcaption><span>nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='apacheconf'><span class='line'><span class="nb">server</span> {
</span><span class='line'>    <span class="nb">listen</span>       <span class="m">443</span>;
</span><span class='line'>    <span class="nb">server_name</span> *.example.com;
</span><span class='line'>
</span><span class='line'>    <span class="nb">ssl</span>                  <span class="k">on</span>;
</span><span class='line'>    <span class="nb">ssl_certificate</span>      ssl/proxyserver.crt;
</span><span class='line'>    <span class="nb">ssl_certificate_key</span>  ssl/proxyserver.example.com.pem;
</span><span class='line'>
</span><span class='line'>    <span class="nb">ssl_session_timeout</span>  <span class="m">5</span>m;
</span><span class='line'>
</span><span class='line'>    <span class="nb">ssl_protocols</span>  SSLv2 SSLv3 TLSv1;
</span><span class='line'>    <span class="nb">ssl_ciphers</span>  <span class="k">ALL</span>:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv1:+EXP;
</span><span class='line'>    <span class="nb">ssl_prefer_server_ciphers</span>   <span class="k">on</span>;
</span><span class='line'>
</span><span class='line'>    <span class="nb">access_log</span>  logs/ssl-access.log main;
</span><span class='line'>    <span class="nb">error_log</span> logs/ssl-error.log <span class="k">warn</span>;
</span><span class='line'>
</span><span class='line'>    <span class="nb">location</span> / {
</span><span class='line'>        <span class="nb">resolver</span> <span class="m">127.0.0.1</span>;
</span><span class='line'>        <span class="nb">include</span> conf.d/proxy.conf;
</span><span class='line'>        <span class="nb">proxy_pass</span> http://$host$request_uri;
</span><span class='line'>    <span class="err">}</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>El contenido del archivo proxy.conf es:</p>

<figure class='code'><figcaption><span>proxy.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='apacheconf'><span class='line'><span class="nb">proxy_redirect</span>          <span class="k">off</span>;
</span><span class='line'><span class="nb">proxy_set_header</span>        Host            $host;
</span><span class='line'><span class="nb">proxy_set_header</span>        X-Real-IP       $remote_addr;
</span><span class='line'><span class="nb">proxy_set_header</span>        X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'><span class="nb">client_max_body_size</span>    <span class="m">10</span>m;
</span><span class='line'><span class="nb">client_body_buffer_size</span> <span class="m">512</span>k;
</span><span class='line'><span class="c">#proxy_connect_timeout   75; #Default is 60</span>
</span><span class='line'><span class="nb">proxy_send_timeout</span>      <span class="m">90</span>;
</span><span class='line'><span class="nb">proxy_read_timeout</span>      <span class="m">90</span>;
</span><span class='line'><span class="nb">proxy_buffers</span>           <span class="m">64</span> <span class="m">4</span>k;
</span></code></pre></td></tr></table></div></figure>


<p>El contenido del archivo ssl.conf es:</p>

<figure class='code'><figcaption><span>ssl.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='apacheconf'><span class='line'><span class="nb">proxy_set_header</span>  X-Forwarded-Proto https;
</span></code></pre></td></tr></table></div></figure>


<p>Y en el server interno, agregar en el archivo .conf del apache para el sitio sin ssl:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='apacheconf'><span class='line'><span class="nb">RewriteEngine</span> <span class="k">On</span>
</span><span class='line'><span class="nb">RewriteCond</span> %{HTTP:X-Forwarded-Proto} !=https
</span><span class='line'><span class="nb">RewriteRule</span> (.*) https://%{SERVER_NAME}/$1 [redirect=permanent,last]
</span></code></pre></td></tr></table></div></figure>


<p>Para referencia sobre los headers de http:
http://en.wikipedia.org/wiki/List_of_HTTP_header_fields</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[borrando viejos builds en jenkins]]></title>
    <link href="http://devops-ar.github.com/blog/2012/08/08/borrando-viejos-builds-en-jenkins/"/>
    <updated>2012-08-08T11:17:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/08/08/borrando-viejos-builds-en-jenkins</id>
    <content type="html"><![CDATA[<p>Algunos jobs crean builds grandes y con el tiempo, empiezan a ocupar espacio hasta llenar el disco duro.</p>

<p>Para solucionar este problema, se pueden borrar periodicamente los builds mas viejos. El siguiente comando va a eliminar los builds de mas de 10 dias:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">for </span>i in <span class="sb">`</span>find /var/lib/jenkins/jobs -name builds<span class="sb">`</span> ; <span class="k">do </span>find <span class="nv">$i</span>  -mtime +10 -delete ; <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>Un ejemplo práctico:</p>

<p>El filesystem estaba sin espacio libre</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@ci-server builds<span class="o">]</span><span class="c"># df -h</span>
</span><span class='line'>Filesystem            Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/mapper/VolGroup00-LogVol00
</span><span class='line'>                       18G   17G     0 100% /
</span><span class='line'>/dev/sda1              99M   19M   76M  20% /boot
</span><span class='line'>tmpfs                 506M     0  506M   0% /dev/shm
</span></code></pre></td></tr></table></div></figure>


<p>Habia una carpeta de builds ocupando 11G:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@ci-server MyProject<span class="o">]</span><span class="c"># for i in `find /var/lib/jenkins/jobs -name builds` ; do du -ksh $i ; done</span>
</span><span class='line'>27M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>/builds
</span><span class='line'>112M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-datastore/builds
</span><span class='line'>7.9M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-tools/builds
</span><span class='line'>59M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-user/builds
</span><span class='line'>144K  /var/lib/jenkins/jobs/MyProject/modules/com.globant.query<span class="nv">$query</span>-xhtml/builds
</span><span class='line'>54M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$query</span>-xhtml/builds
</span><span class='line'>15M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-jquery/builds
</span><span class='line'>27M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$dev</span>/builds
</span><span class='line'>26M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-login/builds
</span><span class='line'>1.6G  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-style/builds
</span><span class='line'>19M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-media/builds
</span><span class='line'>72M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-local-login/builds
</span><span class='line'>11G /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-web/builds
</span><span class='line'>11M /var/lib/jenkins/jobs/MyProject/builds
</span><span class='line'><span class="o">[</span>root@ci-server MyProject<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>Eliminando los builds viejos</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@ci-server MyProject<span class="o">]</span><span class="c"># for i in `find /var/lib/jenkins/jobs -name builds` ; do find $i  -mtime +10 -delete ; done</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y ahora queda mejor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@ci-server MyProject<span class="o">]</span><span class="c"># for i in `find /var/lib/jenkins/jobs -name builds` ; do du -ksh $i ; done</span>
</span><span class='line'>3.7M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>/builds
</span><span class='line'>18M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-datastore/builds
</span><span class='line'>7.1M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-tools/builds
</span><span class='line'>23M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-user/builds
</span><span class='line'>8.7M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$query</span>-xhtml/builds
</span><span class='line'>12M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-jquery/builds
</span><span class='line'>4.1M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$dev</span>/builds
</span><span class='line'>13M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-login/builds
</span><span class='line'>239M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-style/builds
</span><span class='line'>6.9M  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-media/builds
</span><span class='line'>12M /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-local-login/builds
</span><span class='line'>3.4G  /var/lib/jenkins/jobs/MyProject/modules/com.acme.MyProject<span class="nv">$MyProject</span>-web/builds
</span><span class='line'>11M /var/lib/jenkins/jobs/MyProject/builds
</span></code></pre></td></tr></table></div></figure>


<p>El espacio en disco volvio a la normalidad.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@ci-server MyProject<span class="o">]</span><span class="c"># df -h</span>
</span><span class='line'>Filesystem            Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/mapper/VolGroup00-LogVol00
</span><span class='line'>                   18G  7.0G  9.5G  43% /
</span><span class='line'>/dev/sda1              99M   19M   76M  20% /boot
</span><span class='line'>tmpfs                 506M     0  506M   0% /dev/shm
</span><span class='line'><span class="o">[</span>root@ci-server MyProject<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[permisos en directorio www]]></title>
    <link href="http://devops-ar.github.com/blog/2012/08/07/permisos-en-directorio-www/"/>
    <updated>2012-08-07T18:18:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/08/07/permisos-en-directorio-www</id>
    <content type="html"><![CDATA[<h2>tl;dr</h2>

<p>Suele suceder que un equipo de desarrolladores necesita trabajar de manera conjunta sobre un mismo directorio.</p>

<p>La solución es sencilla.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chown -R root /var/www/html/
</span><span class='line'>chmod 775  /var/www/html/
</span><span class='line'>chgrp -R dev  /var/www/html/
</span><span class='line'>chmod g+s   /var/www/html/
</span><span class='line'>setfacl -d -m g::rwx /var/www/html
</span><span class='line'>setfacl -d -m o::rx /var/www/html
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<h2>En detalle</h2>

<p>Primero comprobamos que valores tiene umask.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@webserver ~<span class="o">]</span><span class="c"># su - john.doe</span>
</span><span class='line'><span class="o">[</span>john.doe@webserver ~<span class="o">]</span><span class="nv">$ </span><span class="nb">umask</span> -S
</span><span class='line'><span class="nv">u</span><span class="o">=</span>rwx,g<span class="o">=</span>rx,o<span class="o">=</span>rx
</span><span class='line'><span class="o">[</span>john.doe@webserver ~<span class="o">]</span><span class="nv">$ </span>
</span><span class='line'><span class="o">[</span>john.doe@webserver ~<span class="o">]</span><span class="nv">$ </span><span class="nb">umask</span>
</span><span class='line'>0022
</span><span class='line'><span class="o">[</span>john.doe@webserver ~<span class="o">]</span><span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Se utiliza como referencia <a href="http://www.cyberciti.biz/tips/understanding-linux-unix-umask-value-usage.html">este enlace</a>.</p>

<p>Revisando como funcionan las distingas umask en los  permisos de archivos y directorios.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>john.doe@webserver tmp<span class="o">]</span><span class="nv">$ </span><span class="k">for </span>i in <span class="sb">`</span>seq 7<span class="sb">`</span> ; <span class="k">do </span>rm -fr hi foo ; <span class="nb">echo</span> <span class="s2">&quot;-- usando umask 00$i --&quot;</span> ; <span class="nb">umask </span>00<span class="nv">$i</span> ; mkdir hi ; touch foo ; ls -l | grep -v total;  <span class="k">done</span>
</span><span class='line'>-- usando <span class="nb">umask </span>001 --
</span><span class='line'>-rw-rw-rw- 1 john.doe users  0 Aug  7 15:30 foo
</span><span class='line'>drwxrwxrw- 2 john.doe users 48 Aug  7 15:30 hi
</span><span class='line'>-- usando <span class="nb">umask </span>002 --
</span><span class='line'>-rw-rw-r-- 1 john.doe users  0 Aug  7 15:30 foo
</span><span class='line'>drwxrwxr-x 2 john.doe users 48 Aug  7 15:30 hi
</span><span class='line'>-- usando <span class="nb">umask </span>003 --
</span><span class='line'>-rw-rw-r-- 1 john.doe users  0 Aug  7 15:30 foo
</span><span class='line'>drwxrwxr-- 2 john.doe users 48 Aug  7 15:30 hi
</span><span class='line'>-- usando <span class="nb">umask </span>004 --
</span><span class='line'>-rw-rw--w- 1 john.doe users  0 Aug  7 15:30 foo
</span><span class='line'>drwxrwx-wx 2 john.doe users 48 Aug  7 15:30 hi
</span><span class='line'>-- usando <span class="nb">umask </span>005 --
</span><span class='line'>-rw-rw--w- 1 john.doe users  0 Aug  7 15:30 foo
</span><span class='line'>drwxrwx-w- 2 john.doe users 48 Aug  7 15:30 hi
</span><span class='line'>-- usando <span class="nb">umask </span>006 --
</span><span class='line'>-rw-rw---- 1 john.doe users  0 Aug  7 15:30 foo
</span><span class='line'>drwxrwx--x 2 john.doe users 48 Aug  7 15:30 hi
</span><span class='line'>-- usando <span class="nb">umask </span>007 --
</span><span class='line'>-rw-rw---- 1 john.doe users  0 Aug  7 15:30 foo
</span><span class='line'>drwxrwx--- 2 john.doe users 48 Aug  7 15:30 hi
</span><span class='line'><span class="o">[</span>john.doe@webserver tmp<span class="o">]</span><span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>El objetivo es crear una carpeta <code>/var/www/html</code> donde todos los desarrolladores puedan trabajar. Para esto, se creo el grupo <b>dev</b> y se adicionaron todos los desarrolladores al mismo.  Primero se prueba en directorio que creamos temporalmente <code>/var/www/shared</code>.</p>

<p>Hay que activar el sticky bit en el directorio (<code>chmod g+s shared</code>). Esto es lo que garantiza que los nuevos archivos y directorios, sean creados con el mismo grupo del directorio padre. Luego, se asigna el grupo <b>dev</b> como grupo por defecto para ese directorio (<code>setfacl -Rm d:g:dev:rwX shared</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@webserver www<span class="o">]</span><span class="c"># chmod g+s shared</span>
</span><span class='line'><span class="o">[</span>root@webserver www<span class="o">]</span><span class="c"># getfacl shared</span>
</span><span class='line'><span class="c"># file: shared</span>
</span><span class='line'><span class="c"># owner: root</span>
</span><span class='line'><span class="c"># group: root</span>
</span><span class='line'><span class="c"># flags: -s-</span>
</span><span class='line'>user::rwx
</span><span class='line'>group::r-x
</span><span class='line'>other::r-x
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@webserver www<span class="o">]</span><span class="c"># </span>
</span><span class='line'><span class="o">[</span>root@webserver www<span class="o">]</span><span class="c"># setfacl -Rm d:g:dev:rwX shared</span>
</span><span class='line'><span class="o">[</span>root@webserver www<span class="o">]</span><span class="c"># getfacl shared</span>
</span><span class='line'><span class="c"># file: shared</span>
</span><span class='line'><span class="c"># owner: root</span>
</span><span class='line'><span class="c"># group: root</span>
</span><span class='line'><span class="c"># flags: -s-</span>
</span><span class='line'>user::rwx
</span><span class='line'>group::r-x
</span><span class='line'>other::r-x
</span><span class='line'>default:user::rwx
</span><span class='line'>default:group::r-x
</span><span class='line'>default:group:dev:rwx
</span><span class='line'>default:mask::rwx
</span><span class='line'>default:other::r-x
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@webserver www<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>En resumen, son estos los comandos.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rm -fr /var/www/shared
</span><span class='line'>mkdir /var/www/shared
</span><span class='line'>chmod 775 /var/www/shared
</span><span class='line'>chgrp dev /var/www/shared
</span><span class='line'>chmod g+s /var/www/shared
</span><span class='line'>setfacl -d -m g::rwx /var/www/shared
</span><span class='line'>setfacl -d -m o::rx /var/www/shared
</span><span class='line'>su - john.doe
</span><span class='line'>touch /var/www/shared/foo
</span><span class='line'>ls -al /var/www/shared
</span></code></pre></td></tr></table></div></figure>


<p>Asi quedan los permisos de un archivo creado por un desarrollador.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>john.doe@webserver ~<span class="o">]</span><span class="nv">$ </span>ls -al /var/www/shared
</span><span class='line'>total 20
</span><span class='line'>drwxrwsr-x+ 2 root         dev  4096 Aug  7 15:47 .
</span><span class='line'>drwxr-xr-x  8 root         root 4096 Aug  7 15:47 ..
</span><span class='line'>-rw-rw-r--  1 john.doe dev     0 Aug  7 15:47 foo
</span><span class='line'><span class="o">[</span>john.doe@webserver ~<span class="o">]</span><span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora, se realiza la configuración en el directorio html.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chown -R root /var/www/html/
</span><span class='line'>chmod 775  /var/www/html/
</span><span class='line'>chgrp -R dev  /var/www/html/
</span><span class='line'>chmod g+s   /var/www/html/
</span><span class='line'>setfacl -d -m g::rwx /var/www/html
</span><span class='line'>setfacl -d -m o::rx /var/www/html
</span><span class='line'><span class="c"># para un sitio en wordpress</span>
</span><span class='line'>chown -R apache /var/www/html/wp-content/uploads
</span><span class='line'>chown -R apache /var/www/html/wp-content/themes
</span><span class='line'>
</span><span class='line'>find /var/www/html -type d -exec chmod g+s <span class="o">{}</span> <span class="se">\;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Como era un sitio de wordpress, hacemos unos ajustes finales.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@webserver html<span class="o">]</span><span class="c"># ls -al wp-content/</span>
</span><span class='line'>total 56
</span><span class='line'>drwxrwxr-x  6 root   dev 4096 Jul  6 16:13 .
</span><span class='line'>drwxrwsr-x+ 5 root   dev 4096 Jul 11 10:10 ..
</span><span class='line'>drwxr-xr-x  2 root   dev 4096 Jul  4 11:20 acme
</span><span class='line'>-rw-rw-r--  1 root   dev   30 May  4  2007 index.php
</span><span class='line'>drwxrwxr-x  4 root   dev 4096 Jul  6 11:06 plugins
</span><span class='line'>drwxrwxr-x  5 apache dev 4096 Jul  3 15:51 themes
</span><span class='line'>drwxrwxr-x  3 apache dev 4096 Jul  3 15:33 uploads
</span><span class='line'><span class="o">[</span>root@webserver html<span class="o">]</span><span class="c"># find /var/www/html -type d -exec chmod g+s {} \;</span>
</span><span class='line'><span class="o">[</span>root@webserver html<span class="o">]</span><span class="c"># ls -al wp-content/</span>
</span><span class='line'>total 56
</span><span class='line'>drwxrwsr-x  6 root   dev 4096 Jul  6 16:13 .
</span><span class='line'>drwxrwsr-x+ 5 root   dev 4096 Jul 11 10:10 ..
</span><span class='line'>drwxr-sr-x  2 root   dev 4096 Jul  4 11:20 acme
</span><span class='line'>-rw-rw-r--  1 root   dev   30 May  4  2007 index.php
</span><span class='line'>drwxrwsr-x  4 root   dev 4096 Jul  6 11:06 plugins
</span><span class='line'>drwxrwsr-x  5 apache dev 4096 Jul  3 15:51 themes
</span><span class='line'>drwxrwsr-x  3 apache dev 4096 Jul  3 15:33 uploads
</span><span class='line'><span class="o">[</span>root@webserver html<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[configurando jboss 6]]></title>
    <link href="http://devops-ar.github.com/blog/2012/06/14/configurando-jboss-6/"/>
    <updated>2012-06-14T12:55:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/06/14/configurando-jboss-6</id>
    <content type="html"><![CDATA[<p>Para configurar jboss 6 de manera que funcione con puertos no estandards (porque en el mismo server se esta ejecutando otra aplicacion que ya usa esos puertos, digamos, jenkins) se requieren dos cambios. El primero en el script que inicia el jboss. El segundo, al script que lo detiene, pues de lo contrario, no podria funcionar.</p>

<p>Primero se le adiciona la linea <code>JAVA_OPTS="$JAVA_OPTS -Djboss.service.binding.set=\"ports-01\""</code> al script que inicia el jboss.</p>

<figure class='code'><figcaption><span>JBOSS_HOME/bin/run.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Setup JBoss specific properties</span>
</span><span class='line'><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS -Djboss.service.binding.set=\&quot;ports-01\&quot;&quot;</span>
</span><span class='line'><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;${JAVA_OPTS:+$JAVA_OPTS -Dprogram.name=$PROGNAME}&quot;</span>
</span><span class='line'><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;${JAVA_OPTS:--Dprogram.name=$PROGNAME}&quot;</span>
</span><span class='line'><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;${JAVA_OPTS:+$JAVA_OPTS -Dlogging.configuration=file:${DIRNAME}/logging.properties}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Luego, se define el puerto (RMI) en el script que detiene la aplicación. En este caso, el propio script que trae el jboss. Para el caso de un CentOS seria una copia de jboss_init_redhat.sh.</p>

<figure class='code'><figcaption><span>/etc/rc.d/init.d/jboss</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#JBOSS_CMD_STOP=${JBOSS_CMD_STOP:-&quot;java -classpath $JBOSSCP org.jboss.Shutdown --shutdown&quot;}</span>
</span><span class='line'><span class="nv">JBOSS_CMD_STOP</span><span class="o">=</span><span class="k">${</span><span class="nv">JBOSSSTOP</span><span class="k">:-</span><span class="s2">&quot;$JBOSS_HOME/bin/shutdown.sh --host localhost --port=1190&quot;</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Aca vemos en acción los cambios realizados.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@example.com ~<span class="o">]</span><span class="c"># ps aux | grep jboss | egrep -v &#39;tail|grep&#39;</span>
</span><span class='line'><span class="o">[</span>root@example.com ~<span class="o">]</span><span class="c"># </span>
</span><span class='line'><span class="o">[</span>root@example.com ~<span class="o">]</span><span class="c"># service jboss start</span>
</span><span class='line'><span class="o">[</span>root@example.com ~<span class="o">]</span><span class="c"># ps aux | grep jboss | egrep -v &#39;tail|grep&#39;</span>
</span><span class='line'>jboss    23962  0.0  0.0  63856  1168 ?        S    10:39   0:00 /bin/sh /opt/jboss/bin/run.sh -c default
</span><span class='line'>jboss    24014 97.7  5.0 1037244 205740 ?      Sl   10:39   0:23 java -server -Xms128m -Xmx512m -XX:MaxPermSize<span class="o">=</span>256m -Dorg.jboss.resolver.warning<span class="o">=</span><span class="nb">true</span> -Dsun.rmi.dgc.client.gcInterval<span class="o">=</span>3600000 -Dsun.rmi.dgc.server.gcInterval<span class="o">=</span>3600000 -Djava.net.preferIPv4Stack<span class="o">=</span><span class="nb">true</span> -Djboss.service.binding.set<span class="o">=</span>ports-01 -Dprogram.name<span class="o">=</span>run.sh -Dlogging.configuration<span class="o">=</span>file:/opt/jboss/bin/logging.properties -Djava.library.path<span class="o">=</span>/opt/jboss/bin/native/lib64 -Djava.endorsed.dirs<span class="o">=</span>/opt/jboss/lib/endorsed -classpath /opt/jboss/bin/run.jar org.jboss.Main -c default
</span><span class='line'><span class="o">[</span>root@example.com ~<span class="o">]</span><span class="c"># service jboss stop</span>
</span><span class='line'>Shutdown message has been posted to the server.
</span><span class='line'>Server shutdown may take a <span class="k">while</span> - check logfiles <span class="k">for </span>completion
</span><span class='line'><span class="o">[</span>root@example.com ~<span class="o">]</span><span class="c"># ps aux | grep jboss | egrep -v &#39;tail|grep&#39;</span>
</span><span class='line'><span class="o">[</span>root@example.com ~<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[sendmail cookbook]]></title>
    <link href="http://devops-ar.github.com/blog/2012/05/19/sendmail-cookbook/"/>
    <updated>2012-05-19T14:02:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/05/19/sendmail-cookbook</id>
    <content type="html"><![CDATA[<p>Postfix se ha convertido en el MTA por excelencia para la mayoría de las distribuciones Linux. Sin embargo, algunas, como CentOS (hasta la 5 al menos) instalan sendmail de manera predeterminada. A menos que estemos instalando un servidor de mensajeria, utilizar sendmail sería la mejor opción. Es sencillo de configurar, ya esta instalado y para el uso que le vamos a dar, cumple su cometido.</p>

<p>Para cubrir la parte de configuración y ahorrarnos ese paso, se armo un cookbook que solo contiene tres archivos.</p>

<p>Lo primero que hacemos es crear un archivo de atributos donde se define el smarthost que se este utilizando. Como todo atributo, puede ser modificado luego a nivel de role o de ambiente (environment), incluso, a nivel de node mediante el uso de un data bag.</p>

<figure class='code'><figcaption><span>cookbooks/sendmail/attributes/default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">default</span><span class="o">[</span><span class="s2">&quot;sendmail&quot;</span><span class="o">][</span><span class="s2">&quot;smarthost&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;mail-gateway.acme.com&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sendmail maneja sus archivos de configuración a través de macros m4. Nunca se editan los archivos .cf tal como se aclaran en los mismos:</p>

<figure class='code'><figcaption><span>sendmail.cf line 25</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#####   DO NOT EDIT THIS FILE!  Only edit the source .mc file.</span>
</span></code></pre></td></tr></table></div></figure>


<p>El archivo de template de sendmail.mc es una copia del archivo original, solo se adiciona la linea de definición del smarthost utilizando el atributo antes definido.</p>

<figure class='code'><figcaption><span>cookbooks/sendmail/templates/default/sendmail.mc.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">define</span><span class="p">(</span><span class="sb">`SMART_HOST&#39;, `</span><span class="o">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;sendmail&#39;</span><span class="o">][</span><span class="s1">&#39;smarthost&#39;</span><span class="o">]</span> <span class="o">%&gt;</span><span class="err">&#39;</span><span class="p">)</span><span class="n">dnl</span>
</span></code></pre></td></tr></table></div></figure>


<p>El tercer archivo es la receta como tal.</p>

<figure class='code'><figcaption><span>cookbooks/sendmail/recipes/default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">package</span> <span class="s2">&quot;m4&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;sendmail&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;sendmail-cf&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="s1">&#39;sendmail&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">template</span> <span class="s2">&quot;/etc/mail/sendmail.mc&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;sendmail.mc.erb&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s2">&quot;execute[create_sendmailcf_file]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[sendmail]&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;create_sendmailcf_file&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;/usr/bin/m4 /etc/mail/sendmail.mc &gt; /etc/mail/sendmail.cf&quot;</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:nothing</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Las tres primeras lineas se aseguran de que los paquetes requeridos se encuentren instalados en el sistema.</p>

<p>La declaración del servicio <code>sendmail</code> se encarga de configurarlo para que inicie de manera automática y poder enviarle notificaciones desde otras partes de la receta.</p>

<p>Se crea el archivo de configuración del sendmail: sendmail.mc a partir del template. En el caso de que ya existiera no se hace mas nada. Para los casos en que se crea o fue modificado, se ejecuta de manera inmediata el comando de creación del archivo sendmail.cf y se declara que el servicio de sendmail sea reiniciado, para tomar los cambios aplicados, una vez que el chef haya terminado de aplicar todas las recetas.</p>

<p>El comando <code>create_sendmailcf_file</code> no hace nada de manera predeterminada. Solo se ejecuta en caso de modificación del template del archivo de configuración del sendmail.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[configurando vncserver en centos]]></title>
    <link href="http://devops-ar.github.com/blog/2012/04/10/configurando-vncserver-en-centos/"/>
    <updated>2012-04-10T18:09:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/04/10/configurando-vncserver-en-centos</id>
    <content type="html"><![CDATA[<p>Primero nos aseguramos de que los paquetes estan instalados.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@nirvana ~<span class="o">]</span><span class="c"># rpm -qa | grep vnc</span>
</span><span class='line'>vnc-4.1.2-9.el5
</span><span class='line'>vnc-server-4.1.2-9.el5
</span><span class='line'><span class="o">[</span>root@nirvana ~<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>Para un CentOS se puede instalar utilizan yum, para un RHEL &#8230; buscar las rpm en los CD de instalación.</p>

<p>La primera vez que intentamos iniciar el servicio puede fallar.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@nirvana .vnc<span class="o">]</span><span class="c"># service vncserver start</span>
</span><span class='line'>Starting VNC server: no displays configured                <span class="o">[</span>  OK  <span class="o">]</span>
</span><span class='line'><span class="o">[</span>root@nirvana .vnc<span class="o">]</span><span class="c">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>El mensaje de error es explícito: el servicio no ha sido configurado. Hay tener en cuenta que el vnc se utiliza para acceder a una sesión gráfica en un servidor remoto. Esto quiere decir que se accede a una sesión directamente, no a un gestor de sesiones. El vnc server va a escuchar en un puerto distinto para cada sesión que se defina. De manera predeterminada el vnc server escucha en el puerto 5900 y cada sesión escucha por un puerto consecutivo a partir de ese número. Por lo tanto, para conectar con el cliente VNC, serán el 5900 + &#8220;número de pantalla o display number&#8221;, 5901 para el 1, 5902 para el 2 y asi sucesivamente.</p>

<!-- more -->


<p>Se utiliza como guía el <a href="http://wiki.centos.org/HowTos/VNC-Server">tutorial de CentOS</a>.</p>

<p>Primero se crea la cuenta de usuario si no existiera. En la sesión de dicho usuario se crea una contraseña para conectarse por vnc (puede ser similar pero es independiente de la contraseña del sistema).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>adduser juan
</span><span class='line'>su - juan
</span><span class='line'>vncpasswd
</span><span class='line'><span class="c"># tecleamos la contraseña para el vnc</span>
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>El vnc utiliza un archivo para iniciar aplicaciones al iniciar la sesión gráfica. Este archivo <code>xstartup</code> deberia quedar de la siguiente manera:</p>

<figure class='code'><figcaption><span>/home/juan/.vnc/xstartup </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="k">while </span><span class="nb">true</span> ; <span class="k">do </span>xterm ; <span class="k">done</span> <span class="o">)</span> &amp;
</span><span class='line'><span class="c"># Uncomment the following two lines for normal desktop:</span>
</span><span class='line'><span class="nb">unset </span>SESSION_MANAGER
</span><span class='line'><span class="nb">exec</span> /etc/X11/xinit/xinitrc
</span><span class='line'>
</span><span class='line'><span class="o">[</span> -x /etc/vnc/xstartup <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exec</span> /etc/vnc/xstartup
</span><span class='line'><span class="o">[</span> -r <span class="nv">$HOME</span>/.Xresources <span class="o">]</span> <span class="o">&amp;&amp;</span> xrdb <span class="nv">$HOME</span>/.Xresources
</span><span class='line'>xsetroot -solid grey
</span><span class='line'>vncconfig -iconic &amp;
</span><span class='line'>xterm -geometry 80x24+10+10 -ls -title <span class="s2">&quot;$VNCDESKTOP Desktop&quot;</span> &amp;
</span><span class='line'>twm &amp;
</span></code></pre></td></tr></table></div></figure>


<p>Nota: las modificaciones se señalan en negritas, el resto es el archivo original que se creo al ejecutar el comando <code>vncpasswd</code>.</p>

<p>El siguiente paso seria configurar el vnc server. Para esto se edita el archivo correspondiente.</p>

<figure class='code'><figcaption><span>/etc/sysconfig/vncservers</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># The VNCSERVERS variable is a list of display:user pairs.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Uncomment the lines below to start a VNC server on display :2</span>
</span><span class='line'><span class="c"># as my &#39;myusername&#39; (adjust this to your own).  You will also</span>
</span><span class='line'><span class="c"># need to set a VNC password; run &#39;man vncpasswd&#39; to see how</span>
</span><span class='line'><span class="c"># to do that.  </span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># DO NOT RUN THIS SERVICE if your local area network is</span>
</span><span class='line'><span class="c"># untrusted!  For a secure way of using VNC, see</span>
</span><span class='line'><span class="c"># &lt;URL:http://www.uk.research.att.com/archive/vnc/sshvnc.html&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Use &quot;-nolisten tcp&quot; to prevent X connections to your VNC server via TCP.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Use &quot;-nohttpd&quot; to prevent web-based VNC clients connecting.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Use &quot;-localhost&quot; to prevent remote VNC clients connecting except when</span>
</span><span class='line'><span class="c"># doing so through a secure tunnel.  See the &quot;-via&quot; option in the</span>
</span><span class='line'><span class="c"># `man vncviewer&#39; manual page.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># VNCSERVERS=&quot;2:myusername&quot;</span>
</span><span class='line'><span class="c"># VNCSERVERARGS[2]=&quot;-geometry 800x600 -nolisten tcp -nohttpd -localhost&quot;</span>
</span><span class='line'><span class="nv">VNCSERVERS</span><span class="o">=</span><span class="s2">&quot;1:juan&quot;</span>
</span><span class='line'>VNCSERVERARGS<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;-geometry 1024x768&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Solo queda reiniciar el servicio y ya se podra realizar una conexión remota por vnc, a la ip del server, por el puerto 5901, para iniciar una sesión gráfica como el usuario juan.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@nirvana ~<span class="o">]</span><span class="c"># service vncserver restart</span>
</span><span class='line'>Shutting down VNC server: 1:juan                         <span class="o">[</span>  OK  <span class="o">]</span>
</span><span class='line'>Starting VNC server: 1:juan
</span><span class='line'>New <span class="s1">&#39;nirvana:1 (juan)&#39;</span> desktop is nirvana:1
</span><span class='line'>
</span><span class='line'>Starting applications specified in /home/juan/.vnc/xstartup
</span><span class='line'>Log file is /home/juan/.vnc/nirvana:1.log
</span><span class='line'>
</span><span class='line'>                                                           <span class="o">[</span>  OK  <span class="o">]</span>
</span><span class='line'><span class="o">[</span>root@nirvana ~<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>Si se quieren definir mas sesiones, se ejecuta el comando vncpasswd para cada usuario y se declaran el archivo de configuración del vnc server</p>

<figure class='code'><figcaption><span>/etc/sysconfig/vncservers</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">VNCSERVERS</span><span class="o">=</span><span class="s2">&quot;1:juan 2:osvaldo&quot;</span>
</span><span class='line'>VNCSERVERARGS<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;-geometry 800x600&quot;</span>
</span><span class='line'>VNCSERVERARGS<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;-geometry 1024x768&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Si se quisiera modificar el puerto, por ejemplo, hacer que la primera sesión escuche por el puerto 5900, se puede editar el archivo vncserver directamente, definir que el vnc server se inicie utilizando el puerto 5899 de manera tal que cuando se le sume 1 por el primer desktop, quede corriendo por el 5900 como se quiere.</p>

<figure class='code'><figcaption><span>Original /usr/bin/vncserver - linea 125</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nv">$vncPort</span> <span class="o">=</span> <span class="mi">5900</span> <span class="o">+</span> <span class="nv">$displayNumber</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Modificado /usr/bin/vncserver </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nv">$vncPort</span> <span class="o">=</span> <span class="mi">5899</span> <span class="o">+</span> <span class="nv">$displayNumber</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Se reinicia el servicio para aplicar los cambios realizados.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>service vncserver restart
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[instalando el proxy de perforce]]></title>
    <link href="http://devops-ar.github.com/blog/2012/04/09/instalando-el-proxy-de-perforce/"/>
    <updated>2012-04-09T23:29:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/04/09/instalando-el-proxy-de-perforce</id>
    <content type="html"><![CDATA[<p>El proxy de perforce consta de dos procesos. Un script que se conecta al servidor remoto (se requieren credenciales para el mismo que el usuario debera proporcionar) y descarga los archivos para un directorio local de cache en el servidor. Y un demonio, el p4p, al que los clientes locales se conectan como si fuera el server de perforce y le sirve los fetch de los archivos del directorio de cache local mientras que le pasa al servidor real los commits que se hacen.</p>

<!-- more -->


<h2>Crear usuario y directorios</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>adduser perforce
</span><span class='line'>mkdir -p /opt/perforce/<span class="o">{</span>logs,cache<span class="o">}</span>
</span><span class='line'>chown -R perforce  /opt/perforce/<span class="o">{</span>logs,cache<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Archivo de configuracion para mantener las credenciales de acceso fuera de los scripts.</h2>

<figure class='code'><figcaption><span>/home/perforce/.p4config </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">P4USER</span><span class="o">=</span>proxy_user
</span><span class='line'><span class="nv">P4PASSWD</span><span class="o">=</span>secret
</span><span class='line'><span class="nv">P4CLIENT</span><span class="o">=</span>ACME_Proxy
</span></code></pre></td></tr></table></div></figure>


<h2>Script que realiza la sincronizacion.</h2>

<figure class='code'><figcaption><span>/usr/local/bin/p4-sync.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># depende del cliente</span>
</span><span class='line'><span class="nb">export </span><span class="nv">P4CLIENT</span><span class="o">=</span>ACME_Proxy
</span><span class='line'>. ~/.p4config
</span><span class='line'>/usr/local/bin/p4-login.exp <span class="k">${</span><span class="nv">P4PASSWD</span><span class="k">}</span> &gt; /dev/null
</span><span class='line'>p4 info
</span><span class='line'>p4 -Zproxyload sync &gt;&gt; /opt/perforce/logs/p4proxyload.log
</span></code></pre></td></tr></table></div></figure>


<h2>Script que realiza la autenticacion contra el servidor de perforce remoto.</h2>

<p>En principio el comando p4 deberia tomar el password por la variable de entorno $P4PASSWD pero no funcionaba asi que como un workaround, se utiliza este script en expect que logra el mismo resultado.</p>

<figure class='code'><figcaption><span>/usr/local/bin/p4-login.exp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/usr/bin/expect -f</span>
</span><span class='line'><span class="nb">set </span>password <span class="o">[</span>lrange <span class="nv">$argv</span> 0 0<span class="o">]</span>
</span><span class='line'><span class="nb">set </span>timeout -1
</span><span class='line'><span class="c"># now connect launch command</span>
</span><span class='line'>spawn p4 login
</span><span class='line'>match_max 100000
</span><span class='line'><span class="c"># Look for passwod prompt</span>
</span><span class='line'>expect <span class="s2">&quot;*?assword:*&quot;</span>
</span><span class='line'><span class="c"># Send password aka $password</span>
</span><span class='line'>send -- <span class="s2">&quot;$password\r&quot;</span>
</span><span class='line'><span class="c"># send blank line (\r) to make sure we get back to gui</span>
</span><span class='line'>send -- <span class="s2">&quot;\r&quot;</span>
</span><span class='line'>expect eof
</span></code></pre></td></tr></table></div></figure>


<p>El script se invoca desde el crontab del usuario perforce. Para crearlo, ejecutar</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># como root</span>
</span><span class='line'>crontab -u perforce -e
</span><span class='line'><span class="c"># como usuario perforce</span>
</span><span class='line'>crontab -e
</span></code></pre></td></tr></table></div></figure>


<p>Se ejecuta la sincronizacion cada hora en este ejemplo. Quedaria a decision del cliente.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>perforce@p4-server ~<span class="o">]</span><span class="nv">$ </span>crontab -l
</span><span class='line'><span class="nv">MAILTO</span><span class="o">=</span>admin@devops.com.ar
</span><span class='line'>0 * * * * /usr/local/bin/p4-sync.sh
</span></code></pre></td></tr></table></div></figure>


<p>Por ultimo, se lanza el demonio del p4p al que se van a conectar los clientes. Para esto, se crea un archivo de inicio (Centos 5).</p>

<figure class='code'><figcaption><span>/etc/init.d/p4p</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c"># chkconfig: 2345 99 99</span>
</span><span class='line'><span class="c"># description: perforce proxy</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># admin@devops.com.ar</span>
</span><span class='line'><span class="c"># http://maillist.perforce.com/pipermail/perforce-user/2011-October/029215.html</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#   Startup/shutdown script for Perforce</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Source function library. this is where &#39;daemon&#39; comes from</span>
</span><span class='line'>. /etc/rc.d/init.d/functions
</span><span class='line'>
</span><span class='line'><span class="nv">prog</span><span class="o">=</span><span class="s2">&quot;Perforce Proxy&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">p4p_bin</span><span class="o">=</span>/usr/local/bin/p4p
</span><span class='line'><span class="nv">p4user</span><span class="o">=</span>perforce
</span><span class='line'><span class="nv">p4server</span><span class="o">=</span>p4-server.example.com:1444
</span><span class='line'><span class="nv">p4root</span><span class="o">=</span>/opt/perforce
</span><span class='line'><span class="nv">p4cache</span><span class="o">=</span>/opt/perforce/cache
</span><span class='line'><span class="nv">p4port</span><span class="o">=</span>1666
</span><span class='line'><span class="nv">p4log</span><span class="o">=</span>/opt/perforce/logs/p4p.log
</span><span class='line'>
</span><span class='line'>start <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nb">echo</span> -n <span class="s2">$&quot;Starting $prog: &quot;</span>
</span><span class='line'>        daemon --user<span class="o">=</span><span class="nv">$p4user</span> <span class="nv">$p4p_bin</span> -p <span class="nv">$p4port</span> -r <span class="nv">$p4cache</span> -L <span class="nv">$p4log</span> -t <span class="nv">$p4server</span> -d &amp;&gt;/dev/null
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>stop <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c"># stop</span>
</span><span class='line'>        <span class="nb">echo</span> -n <span class="s2">$&quot;Stopping $prog: &quot;</span>
</span><span class='line'>        pkill p4p
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>restart<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        stop
</span><span class='line'>        start
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="nv">$1</span> in
</span><span class='line'>        start<span class="o">)</span>
</span><span class='line'>                start
</span><span class='line'>        ;;
</span><span class='line'>        stop<span class="o">)</span>
</span><span class='line'>                stop
</span><span class='line'>        ;;
</span><span class='line'>        restart<span class="o">)</span>
</span><span class='line'>                restart
</span><span class='line'>        ;;
</span><span class='line'>        *<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">$&quot;Usage: $prog {start|stop|restart}&quot;</span>
</span><span class='line'>        <span class="nb">exit </span>3
</span><span class='line'><span class="k">esac</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exit</span> <span class="nv">$RETVAL</span>
</span></code></pre></td></tr></table></div></figure>


<p>Se asignan permisos de ejecución y se configura para que se ejecute al reiniciar el servidor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chmod 755 /etc/init.d/p4p
</span><span class='line'>chkconfig --add p4p
</span></code></pre></td></tr></table></div></figure>


<p>Se comprueba que el servicio quedo configurado como se esperaba.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@p4-server ~<span class="o">]</span><span class="c"># chkconfig --list p4p</span>
</span><span class='line'>p4p               0:off   1:off   2:on    3:on    4:on    5:on    6:off
</span><span class='line'><span class="o">[</span>root@p4-server ~<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>Para lanzar manualmente el proxy de perforce, se puede utilizar la siguiente linea de comando.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo -u perforce /usr/local/bin/p4p -p 1666 -t p4-server.example.com:1444 -r /opt/perforce/cache -L /opt/perforce/logs/p4p.log -d
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[usando gitolite]]></title>
    <link href="http://devops-ar.github.com/blog/2012/03/25/usando-gitolite/"/>
    <updated>2012-03-25T03:04:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/03/25/usando-gitolite</id>
    <content type="html"><![CDATA[<p>Una de las ventajas de git es el trabajo en equipos. Como compartir el codigo seria la pregunta. Existen varias alternativas. Hay servicios que ofrecen hospedaje de repositorios para git como el propio github. Entre las opciones si queremos hospedar el repositorio en un servidor propio destacan las siguientes:</p>

<ul>
<li><a href="http://gitorious.org/">gitorious</a>. Es una aplicación Rails para la gestión de proyectos. Permite un manejo via web de los repositorios git. Similar a github en algunos aspectos.</li>
<li><a href="http://repo.or.cz/w/girocco.git/blob/HEAD:/README">girocco</a>. No tiene tantas funcionalidades como gitorious pero la instalación parece mas sencilla. Buena opción a considerar si se requiere una interface web para la administración del repositorio.</li>
<li><a href="https://github.com/tv42/gitosis">gitosis</a>. Permite el acceso a repositorios git via ssh, garantizando control de accesos por repositorio y sin requerir cuentas locales (shell accounts) en el servidor. Esta implementado en Python pero la ultima actualizacion del codigo fue hace 3 años.</li>
<li><a href="https://github.com/sitaramc/gitolite">gitolite</a>. Muy similar a gitosis, implementado en Perl. Se mantiene en desarrollo activo.</li>
</ul>


<p>Como una interface web para administrar usuarios y repositorios no era un requerimiento y gitosis no se mantiene activo, la elección fue gitolite.</p>

<!-- more -->


<p>La forma de trabajo de gitolite es sencilla pero con su propia lógica de funcionamiento. En el servidor donde se instala gitolite no se realiza ninguna configuración de usuarios y/o repositorios en absoluto. Cuando se termina la instalación de gitolite, se crea un repositorio llamado <code>gitolite-admin</code> (dos repositorios en realidad, el otro se llama <code>testing</code> y su objetivo es tal cual describe su nombre: pruebas).</p>

<p>La instalación de gitolite comienza creando una cuenta de usuario en el servidor. Puede ser gitolite (predeterminado si se instala de paquete .deb o .rpm) o git (el username que utilizamos en esta instalación). El acceso a los repositorios será en este caso via ssh. Gitolite utiliza autenticación para el ssh por llaves (públicas/privadas), por lo cual, para acceder a los repositorios, vamos a necesitar las llaves públicas de aquellos usuarios que se conecten a los repositorios.</p>

<p>Copiamos la llave pública de un primer usuario (osvaldo) y creamos el usuario de acceso a los repositorios. Como la instalación la realizamos en un server local, en vez del tradicional mecanismo para copiar llaves públicas que seria <code>ssh-copy-id</code>, logueados como root, se utiliza un simple <code>cp</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo su -
</span><span class='line'>adduser git
</span><span class='line'>cp /home/osvaldo/.ssh/id_rsa.pub /home/git/osvaldo.pub
</span><span class='line'>chown git /home/git/*
</span></code></pre></td></tr></table></div></figure>


<p>Se procede a la instalación de gitolite.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>su - git
</span><span class='line'>git clone git://github.com/sitaramc/gitolite
</span><span class='line'>cat &gt;&gt;~/.bashrc<span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span class='line'><span class="s">PATH=/home/git/bin:$PATH</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>. .bashrc
</span><span class='line'>gitolite/src/gl-system-install
</span><span class='line'>gl-setup -q ~/osvaldo.pub
</span></code></pre></td></tr></table></div></figure>


<p>La instalación crea el repositorio donde se va a almacenar la configuración de gitolite. Hay dos subdirectorios de interes, <code>conf</code> donde se almacena el archivo de configuración: gitolite.conf y <code>keydir</code> donde se van a almacenar las llaves públicas de los usuarios que trabajen con los repositorios.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git@vostro:~<span class="nv">$ </span>gitolite/src/gl-system-install
</span><span class='line'>using default values <span class="k">for </span><span class="nv">EUID</span><span class="o">=</span>1002:
</span><span class='line'>/home/git/bin, /home/git/share/gitolite/conf, /home/git/share/gitolite/hooks
</span><span class='line'>git@vostro:~<span class="nv">$ </span>
</span><span class='line'>git@vostro:~<span class="nv">$ </span>gl-setup -q osvaldo.pub
</span><span class='line'>creating gitolite-admin...
</span><span class='line'>Initialized empty Git repository in /home/git/repositories/gitolite-admin.git/
</span><span class='line'>creating testing...
</span><span class='line'>Initialized empty Git repository in /home/git/repositories/testing.git/
</span><span class='line'><span class="o">[</span>master <span class="o">(</span>root-commit<span class="o">)</span> 6aedb93<span class="o">]</span> gl-setup -q osvaldo.pub
</span><span class='line'> 2 files changed, 8 insertions<span class="o">(</span>+<span class="o">)</span>, 0 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'> create mode 100644 conf/gitolite.conf
</span><span class='line'> create mode 100644 keydir/osvaldo.pub
</span><span class='line'>git@vostro:~<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Los usuarios remotos no van a tener cuentas locales de shell. El acceso a los repositorios es a través del usuario bajo el cual se instalo gitolite (en este caso: git) y utilizando el comando git directamente. Sin embargo, existe un comando que se encuentra disponible a cualquier usuario: info. Este comando se ejecuta via ssh y permite conocer las versiones de gitolite y de git que se encuentran instaladas en el servidor asi como los repositorios  a los cuales el usuario tiene acceso. La lista de repositorios resulta especialmente útil cuando se tienen dudas sobre el nombre exacto con el que fue creado.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~<span class="nv">$ </span>ssh git@vostro info
</span><span class='line'>hello osvaldo, this is gitolite v2.3-33-g233a33d running on git 1.7.2.5
</span><span class='line'>the gitolite config gives you the following access:
</span><span class='line'>     R   W    gitolite-admin
</span><span class='line'>    @R_ @W_   testing
</span><span class='line'>osvaldo@vostro:~<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Para comenzar a trabajar, clonamos el repositorio de administración.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~/src/gitolite/vostro<span class="nv">$ </span>git clone git@vostro:gitolite-admin
</span><span class='line'>Cloning into gitolite-admin...
</span><span class='line'>remote: Counting objects: 6, <span class="k">done</span>.
</span><span class='line'>remote: Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>remote: Total 6 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>Receiving objects: 100% <span class="o">(</span>6/6<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creando usuarios</h2>

<p>Para crear un usuario, adicionamos su llave pública al directorio keyring y comiteamos el repo.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cp fernando.pub gitolite-admin/keyring
</span><span class='line'>git add .
</span><span class='line'>git commit -m <span class="s2">&quot;adding fernando&#39;s pub key&quot;</span>
</span><span class='line'>git push
</span></code></pre></td></tr></table></div></figure>


<p>En la consola aparecería algo así.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/gitolite-admin<span class="nv">$ </span>git commit -m <span class="s2">&quot;adding fernando&#39;s pub key&quot;</span>
</span><span class='line'><span class="o">[</span>master dc4dfed<span class="o">]</span> adding fernando<span class="err">&#39;</span>s pub key
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 0 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'> create mode 100644 keydir/fernando.pub
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/gitolite-admin<span class="nv">$ </span>git push
</span><span class='line'>Counting objects: 6, <span class="k">done</span>.
</span><span class='line'>Delta compression using up to 2 threads.
</span><span class='line'>Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 860 bytes, <span class="k">done</span>.
</span><span class='line'>Total 4 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>remote:
</span><span class='line'>remote:       ***** WARNING *****
</span><span class='line'>remote:         the following users <span class="o">(</span>pubkey files in parens<span class="o">)</span> <span class="k">do </span>not appear in any access rules:
</span><span class='line'>remote: fernando<span class="o">(</span>fernando.pub<span class="o">)</span>
</span><span class='line'>To git@vostro:gitolite-admin
</span><span class='line'>   6aedb93..dc4dfed  master -&gt; master
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/gitolite-admin<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creando repos</h2>

<p>Para crear un repositorio se define en el archivo de configuración: conf/gitolite.conf y se le asignan permisos a los usuarios que corresponda. Al comitear el repo de administración, gitolite se encarga de crear el repositorio y luego queda clonarlo y comenzar a trabajar con el mismo.</p>

<p>A manera de ejemplo se van a crear dos repositorios. Uno llamado &#8220;publico&#8221; donde tengan acceso los dos desarrolladores y otro que se llamará &#8220;privado&#8221;  donde solo un desarrollador tendrá acceso.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='aconf'><span class='line'><span class="err">conf/gitolite</span>.<span class="nb">conf</span>
</span><span class='line'>
</span><span class='line'>repo    gitolite-admin
</span><span class='line'>        <span class="err">RW+</span>     <span class="err">=</span>   <span class="nb">osvaldo</span>
</span><span class='line'>
</span><span class='line'>repo    testing
</span><span class='line'>        <span class="err">RW+</span>     <span class="err">=</span>   <span class="err">@</span><span class="nb">all</span>
</span><span class='line'>
</span><span class='line'>repo  publico
</span><span class='line'>        <span class="err">RW+</span>     <span class="err">=</span>   <span class="nb">osvaldo</span>
</span><span class='line'>        RW+     =   fernando
</span><span class='line'>
</span><span class='line'><span class="nb">repo</span>  privado
</span><span class='line'>        <span class="err">RW+</span>     <span class="err">=</span>   <span class="nb">osvaldo</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>vi conf/gitolite.conf
</span><span class='line'>git add conf/gitolite.conf
</span><span class='line'>git commit -m <span class="s2">&quot;probando visibilidad de repos&quot;</span>
</span><span class='line'>git push
</span></code></pre></td></tr></table></div></figure>


<p>En la consola se pueden ver las operaciones que realiza el gitolite.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/gitolite-admin<span class="nv">$ </span>git push
</span><span class='line'>Counting objects: 7, <span class="k">done</span>.
</span><span class='line'>Delta compression using up to 2 threads.
</span><span class='line'>Compressing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 429 bytes, <span class="k">done</span>.
</span><span class='line'>Total 4 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>remote: creating privado...
</span><span class='line'>remote: Initialized empty Git repository in /home/git/repositories/privado.git/
</span><span class='line'>remote: creating publico...
</span><span class='line'>remote: Initialized empty Git repository in /home/git/repositories/publico.git/
</span><span class='line'>To git@vostro:gitolite-admin
</span><span class='line'>   dc4dfed..ade026e  master -&gt; master
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/gitolite-admin<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora, ambos desarrolladores pueden ejecutar el comando info, pero el resultado va a ser distinto en cada caso. El usuario Osvaldo puede tener acceso a todos los repositorios.</p>

<figure class='code'><figcaption><span>Repositorios disponibles para Osvaldo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/gitolite-admin<span class="nv">$ </span>ssh git@vostro info
</span><span class='line'>hello osvaldo, this is gitolite v2.3-33-g233a33d running on git 1.7.2.5
</span><span class='line'>the gitolite config gives you the following access:
</span><span class='line'>     R   W    gitolite-admin
</span><span class='line'>     R   W    privado
</span><span class='line'>     R   W    publico
</span><span class='line'>    @R_ @W_   testing
</span></code></pre></td></tr></table></div></figure>


<p>Se nota la ausencia del repositorio &#8220;privado&#8221; para el usuario Fernando.</p>

<figure class='code'><figcaption><span>Repositorios disponibles para Fernando</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>fernando@vostro:~<span class="nv">$ </span>ssh git@vostro info
</span><span class='line'>hello fernando, this is gitolite v2.3-33-g233a33d running on git 1.7.2.5
</span><span class='line'>the gitolite config gives you the following access:
</span><span class='line'>     R   W    publico
</span><span class='line'>    @R_ @W_   testing
</span><span class='line'>fernando@vostro:~<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<h2>Trabajando con los repos</h2>

<p>El trabajo con los repositorios es similar a cualquier otro. Lo primero es clonar el repo, se trabaja sobre el mismo y al final, se comitean los cambios al server (push)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>fernando@vostro:~/src<span class="nv">$ </span>git clone git@vostro:publico
</span><span class='line'>Cloning into publico...
</span><span class='line'>warning: You appear to have cloned an empty repository.
</span><span class='line'>fernando@vostro:~/src<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Es probable que el siguiente error aparezca la primera vez que se hace un <code>git push</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>git push
</span><span class='line'>No refs in common and none specified; doing nothing.
</span><span class='line'>Perhaps you should specify a branch such as <span class="s1">&#39;master&#39;</span>.
</span><span class='line'>fatal: The remote end hung up unexpectedly
</span><span class='line'>error: failed to push some refs to <span class="s1">&#39;git@vostro:publico&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tanto en la <a href="http://sitaramc.github.com/gitolite/nagp.html">wiki de gitolite</a> como en <a href="http://stackoverflow.com/questions/6529136/gitolite-default-remotes-for-new-repository">stackoverflow</a> se encuentra la respuesta. No es un problema de gitolite sino de git. El primer <code>git push</code> siempre requiere especificar la &#8220;branch&#8221; a la que le queremos hacer el commit (push), por esta razón, se debe ejecutar de la siguiente manera: <code>git push origin master</code>. La próxima vez, ya bastará con con <code>git push</code>.</p>

<p>La rutina normal seria crear un archivo, hacerle el commit y luego el push al repo.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>vi README.md
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>git add .
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>git commit -m <span class="s2">&quot;adding readme file&quot;</span>
</span><span class='line'><span class="o">[</span>master <span class="o">(</span>root-commit<span class="o">)</span> db7e57b<span class="o">]</span> adding readme file
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 0 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'> create mode 100644 README.md
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>git push origin master
</span><span class='line'>Counting objects: 3, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, 241 bytes, <span class="k">done</span>.
</span><span class='line'>Total 3 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>To git@vostro:publico
</span><span class='line'> * <span class="o">[</span>new branch<span class="o">]</span>      master -&gt; master
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Y si un colega edita  el archivo.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>fernando@vostro:~/src/publico<span class="nv">$ </span>git commit -a
</span><span class='line'>Aborting commit due to empty commit message.
</span><span class='line'>fernando@vostro:~/src/publico<span class="nv">$ </span>git commit -am <span class="s2">&quot;editing readme file&quot;</span>
</span><span class='line'><span class="o">[</span>master 535b69b<span class="o">]</span> editing readme file
</span><span class='line'> 1 files changed, 2 insertions<span class="o">(</span>+<span class="o">)</span>, 0 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'>fernando@vostro:~/src/publico<span class="nv">$ </span>git log
</span><span class='line'>commit 535b69b7b2ca9ab383e5b59eb0285a307056181c
</span><span class='line'>Author: Fernando &lt;fernando@drupblue.com&gt;
</span><span class='line'>Date:   Sun Mar 25 02:54:03 2012 -0300
</span><span class='line'>
</span><span class='line'>    editing readme file
</span><span class='line'>
</span><span class='line'>commit db7e57b4cf414ff6a493941e5915f106548981eb
</span><span class='line'>Author: Osvaldo T. Suarez &lt;otsuarez@gmail.com&gt;
</span><span class='line'>Date:   Sun Mar 25 02:51:48 2012 -0300
</span><span class='line'>
</span><span class='line'>    adding readme file
</span><span class='line'>fernando@vostro:~/src/publico<span class="nv">$ </span>git push
</span><span class='line'>Counting objects: 5, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, 278 bytes, <span class="k">done</span>.
</span><span class='line'>Total 3 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>To git@vostro:publico
</span><span class='line'>   db7e57b..535b69b  master -&gt; master
</span><span class='line'>fernando@vostro:~/src/publico<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Con solo ejecutar un <code>git pull</code> vamos a mantener nuestro repositorio actualizado como debe ser.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>git  pull
</span><span class='line'>Updating db7e57b..535b69b
</span><span class='line'>Fast-forward
</span><span class='line'> README.md |    2 ++
</span><span class='line'> 1 files changed, 2 insertions<span class="o">(</span>+<span class="o">)</span>, 0 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="nv">$ </span>git log
</span><span class='line'>commit 535b69b7b2ca9ab383e5b59eb0285a307056181c
</span><span class='line'>Author: Fernando &lt;fernando@drupblue.com&gt;
</span><span class='line'>Date:   Sun Mar 25 02:54:03 2012 -0300
</span><span class='line'>
</span><span class='line'>    editing readme file
</span><span class='line'>
</span><span class='line'>commit db7e57b4cf414ff6a493941e5915f106548981eb
</span><span class='line'>Author: Osvaldo T. Suarez &lt;otsuarez@gmail.com&gt;
</span><span class='line'>Date:   Sun Mar 25 02:51:48 2012 -0300
</span><span class='line'>
</span><span class='line'>    adding readme file
</span><span class='line'>osvaldo@vostro:~/src/gitolite/vostro/publico<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Por último, pero no menos importante, agradecemos este <a href="http://blacka.com/david/2010/09/28/hosting-your-own-git-repositories/">post de David Blacka</a> sirvio como punto de partida para este articulo.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[instalando blueprint en CentOS 5.5]]></title>
    <link href="http://devops-ar.github.com/blog/2012/03/05/instalando-blueprint-en-centos-5-dot-5/"/>
    <updated>2012-03-05T08:44:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/03/05/instalando-blueprint-en-centos-5-dot-5</id>
    <content type="html"><![CDATA[<p>Para instalar <a href="http://devstructure.com/">Blueprint</a> en CentOS 5.5 necesitamos instalar python 2.6 y git previamente. En algunos entornos se bloquean los puertos salientes y solo se permite acceder a los puertos web (80,443). A continuación se muestran los pasos para instalar Blueprint tomando todo esto en consideración.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm
</span><span class='line'>yum install python26 git
</span><span class='line'><span class="nb">cd</span> /var/tmp
</span><span class='line'>env <span class="nv">GIT_SSL_NO_VERIFY</span><span class="o">=</span><span class="nb">true </span>git clone https://github.com/devstructure/blueprint.git
</span><span class='line'><span class="nb">cd </span>blueprint
</span><span class='line'>git config --global url.<span class="s2">&quot;https://&quot;</span>.insteadOf git://
</span><span class='line'>env <span class="nv">GIT_SSL_NO_VERIFY</span><span class="o">=</span><span class="nb">true </span>git submodule update --init
</span><span class='line'>make <span class="o">&amp;&amp;</span> sudo make install <span class="nv">PYTHON</span><span class="o">=</span>/usr/bin/python26
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[transfiriendo zonas con tsig]]></title>
    <link href="http://devops-ar.github.com/blog/2012/03/01/transfiriendo-zonas-con-tsig/"/>
    <updated>2012-03-01T16:45:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/03/01/transfiriendo-zonas-con-tsig</id>
    <content type="html"><![CDATA[<p>Siguiendo los consejos de <a href="http://blog.wains.be/2007/12/13/centos-5-chroot-dns-with-bind/">Sébastien Wains</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>yum install <span class="nb">bind bind</span>-chroot <span class="nb">bind</span>-libs <span class="nb">bind</span>-utils caching-nameserver
</span><span class='line'><span class="nb">cd</span> /var/named/chroot/etc
</span><span class='line'>rndc-confgen &gt; rndc.key
</span><span class='line'>chown root:named rndc.key
</span><span class='line'><span class="c"># just in case ....</span>
</span><span class='line'>sed -i <span class="s1">&#39;s/^unset ROOTDIR/#unset ROOTDIR/&#39;</span> /etc/sysconfig/named
</span></code></pre></td></tr></table></div></figure>


<p>Vamos a configurar dos dns servers, uno primario y uno secundario:</p>

<ul>
<li>example1.com
  101.33.99.66</li>
<li>anotherhost.example1.com
  65.138.84.46</li>
</ul>


<!-- more -->


<p>Una configuracion tradicional seria similar a la siguiente (guiandonos por <a href="http://prithak.blogspot.com/2010/08/bind-master-and-slave-server.html">aca</a>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='aconf'><span class='line'><span class="err">/var/named/chroot/etc/named</span>.<span class="nb">conf</span>
</span><span class='line'>acl master_servers {
</span><span class='line'>    <span class="err">101</span>.<span class="err">33</span>.<span class="err">99</span>.<span class="err">66/32</span> <span class="err">;</span>
</span><span class='line'><span class="err">};</span>
</span><span class='line'><span class="nb">zone</span> <span class="s2">&quot;example1.com&quot;</span> {
</span><span class='line'>    <span class="nb">type</span> slave;
</span><span class='line'>    <span class="nb">file</span> <span class="s2">&quot;slaves/example1.com&quot;</span>;
</span><span class='line'>    <span class="nb">masters</span> { master_servers; };
</span><span class='line'>    <span class="err">allow-</span><span class="nb">transfer</span> { <span class="k">none</span>; };
</span><span class='line'>    <span class="err">allow-</span><span class="nb">query</span> { <span class="k">any</span>; } ;
</span><span class='line'>    <span class="err">allow-</span><span class="nb">notify</span> { master_servers; };
</span><span class='line'><span class="err">};</span>
</span><span class='line'><span class="nb">zone</span> <span class="s2">&quot;exampleone.com&quot;</span> {
</span><span class='line'>  <span class="nb">type</span> slave;
</span><span class='line'>  <span class="nb">file</span> <span class="s2">&quot;slaves/exampleone.com&quot;</span>;
</span><span class='line'>  <span class="nb">masters</span> { master_servers; };
</span><span class='line'>  <span class="err">allow-</span><span class="nb">transfer</span> { <span class="k">none</span>; };
</span><span class='line'>  <span class="err">allow-</span><span class="nb">query</span> { <span class="k">any</span>; } ;
</span><span class='line'>  <span class="err">allow-</span><span class="nb">notify</span> { master_servers; };
</span><span class='line'><span class="err">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>THIS METHOD OF ZONE TRANSFER IS HIGHLY INSECURE AS IT USES IP as the basis of transfer. Malicious hackers can use IP Spoofing tricks to trick a DNS server into performing zone transfers. To mitigate this risk it is advised to use TSIG or Transaction signature which uses  a one-way hash function to provide authentication and data integrity.</p>

<p>Seguimos entonces <a href="http://www.cyberciti.biz/faq/unix-linux-bind-named-configuring-tsig/">otra</a> guia.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rndc-confgen -a hmac-md5 -k rndc-key -b 256
</span><span class='line'>dnssec-keygen -a HMAC-MD5 -b 512 -n HOST rndc-key
</span></code></pre></td></tr></table></div></figure>


<h2>@master</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> /var/named/chroot/etc/
</span><span class='line'>dnssec-keygen -a HMAC-MD5 -b 512 -n HOST rndc-key
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>cat Krndc-key.+157+32073.private
</span><span class='line'>Private-key-format: v1.2
</span><span class='line'>Algorithm: 157 <span class="o">(</span>HMAC_MD5<span class="o">)</span>
</span><span class='line'>Key: GFivxZnevSPcNsgaGCc9RHasIzZFSEiKTtme0UIPnNiOZk6ZQ3kXuwXetS9iE+ynei2p5pkp4DUm33YiVICZlA<span class="o">==</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>/var/named/chroot/etc/rndc.key</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='aconf'><span class='line'><span class="nb">key</span> <span class="s2">&quot;TRANSFER&quot;</span> {
</span><span class='line'>          <span class="nb">algorithm</span> hmac-md5;
</span><span class='line'>          <span class="nb">secret</span> <span class="s2">&quot;GFivxZnevSPcNsgaGCc9RHasIzZFSEiKTtme0UIPnNiOZk6ZQ3kXuwXetS9iE+ynei2p5pkp4DUm33YiVICZlA==&quot;</span>;
</span><span class='line'><span class="err">};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>/etc/rndc.conf </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='aconf'><span class='line'><span class="nb">key</span> <span class="s2">&quot;TRANSFER&quot;</span> {
</span><span class='line'>          <span class="nb">algorithm</span> hmac-md5;
</span><span class='line'>          <span class="nb">secret</span> <span class="s2">&quot;GFivxZnevSPcNsgaGCc9RHasIzZFSEiKTtme0UIPnNiOZk6ZQ3kXuwXetS9iE+ynei2p5pkp4DUm33YiVICZlA==&quot;</span>;
</span><span class='line'><span class="err">};</span>
</span><span class='line'><span class="nb">options</span> {     default-key <span class="s2">&quot;TRANSFER&quot;</span>;   default-server <span class="m">127.0.0.1</span>;    default-port <span class="m">953</span>; };
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>/var/named/chroot/etc/named.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='aconf'><span class='line'><span class="nb">include</span> <span class="s2">&quot;/etc/bind/rndc.key&quot;</span>;
</span><span class='line'><span class="c"># Slave server IP # 1</span>
</span><span class='line'><span class="nb">server</span> <span class="m">65.138.84.46</span> {
</span><span class='line'>        <span class="nb">keys</span> {
</span><span class='line'>                <span class="err">TRANSFER;</span>
</span><span class='line'>    <span class="err">};</span>
</span><span class='line'><span class="err">};</span>
</span><span class='line'><span class="nb">controls</span> {
</span><span class='line'>        <span class="nb">inet</span> <span class="m">127.0.0.1</span> port <span class="m">953</span>
</span><span class='line'>                <span class="nb">allow</span> { <span class="m">127.0.0.1</span>; } keys { <span class="s2">&quot;TRANSFER&quot;</span>; };
</span><span class='line'><span class="err">};</span>
</span><span class='line'><span class="nb">options</span> {
</span><span class='line'>    <span class="nb">directory</span>                <span class="s2">&quot;/var/named&quot;</span>; // the default
</span><span class='line'>    <span class="err">pid-</span><span class="nb">file</span>                 <span class="s2">&quot;/var/run/named/named.pid&quot;</span>;
</span><span class='line'>    <span class="err">dump-</span><span class="nb">file</span>                <span class="s2">&quot;data/cache_dump.db&quot;</span>;
</span><span class='line'>    <span class="err">statistics-</span><span class="nb">file</span>          <span class="s2">&quot;data/named_stats.txt&quot;</span>;
</span><span class='line'>    <span class="err">allow-</span><span class="nb">transfer</span> {<span class="s2">&quot;none&quot;</span>;};
</span><span class='line'>    <span class="err">also-</span><span class="nb">notify</span> { <span class="m">65.138.84.46</span>; };
</span><span class='line'>    <span class="nb">notify</span> no;
</span><span class='line'><span class="err">};</span>
</span><span class='line'><span class="nb">zone</span> <span class="s2">&quot;example1.com&quot;</span> {
</span><span class='line'>    <span class="nb">type</span> master;
</span><span class='line'>    <span class="nb">file</span> <span class="s2">&quot;data/example1.com&quot;</span>;
</span><span class='line'>    <span class="err">allow-</span><span class="nb">transfer</span> { key TRANSFER; };
</span><span class='line'>    <span class="err">allow-</span><span class="nb">query</span> { <span class="k">any</span>; } ;
</span><span class='line'>    <span class="nb">notify</span> explicit;
</span><span class='line'><span class="err">};</span>
</span><span class='line'>
</span><span class='line'><span class="nb">zone</span> <span class="s2">&quot;exampleone.com&quot;</span> {
</span><span class='line'>  <span class="nb">type</span> master;
</span><span class='line'>  <span class="nb">file</span> <span class="s2">&quot;data/exampleone.com&quot;</span>;
</span><span class='line'>  <span class="err">allow-</span><span class="nb">transfer</span> { key TRANSFER; };
</span><span class='line'>  <span class="err">allow-</span><span class="nb">query</span> { <span class="k">any</span>; } ;
</span><span class='line'>  <span class="nb">notify</span> explicit;
</span><span class='line'><span class="err">};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rndc reload
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rndc reload
</span><span class='line'>server reload successful
</span></code></pre></td></tr></table></div></figure>


<h2>@slave</h2>

<p>/var/named/chroot/etc/rndc.key
key &#8220;TRANSFER&#8221; {</p>

<pre><code>algorithm hmac-md5;
secret "GFivxZnevSPcNsgaGCc9RHasIzZFSEiKTtme0UIPnNiOZk6ZQ3kXuwXetS9iE+ynei2p5pkp4DUm33YiVICZlA==";
</code></pre>

<p>};</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="sb">```</span>aconf /var/named/chroot/etc/named.conf
</span><span class='line'>include <span class="s2">&quot;/etc/rndc.key&quot;</span>;
</span><span class='line'>
</span><span class='line'>controls <span class="o">{</span> inet 127.0.0.1 port 953 allow <span class="o">{</span> 127.0.0.1; <span class="o">}</span> keys <span class="o">{</span> <span class="s2">&quot;TRANSFER&quot;</span>; <span class="o">}</span>; <span class="o">}</span>;
</span><span class='line'>
</span><span class='line'>options <span class="o">{</span>
</span><span class='line'>    // Put files that named is allowed to write in the data/ directory:
</span><span class='line'>    directory                <span class="s2">&quot;/var/named&quot;</span>; // the default
</span><span class='line'>    pid-file                 <span class="s2">&quot;/var/run/named/named.pid&quot;</span>;
</span><span class='line'>    dump-file                <span class="s2">&quot;data/cache_dump.db&quot;</span>;
</span><span class='line'>    statistics-file          <span class="s2">&quot;data/named_stats.txt&quot;</span>;
</span><span class='line'>   /* memstatistics-file     <span class="s2">&quot;data/named_mem_stats.txt&quot;</span>; */
</span><span class='line'>    allow-transfer <span class="o">{</span><span class="s2">&quot;none&quot;</span>;<span class="o">}</span>;
</span><span class='line'><span class="o">}</span>;
</span><span class='line'>
</span><span class='line'>logging <span class="o">{</span>
</span><span class='line'>    channel default_debug <span class="o">{</span>
</span><span class='line'>            file <span class="s2">&quot;data/named.run&quot;</span>;
</span><span class='line'>            severity dynamic;
</span><span class='line'>    <span class="o">}</span>;
</span><span class='line'><span class="o">}</span>;
</span><span class='line'>
</span><span class='line'><span class="c"># Master server IP</span>
</span><span class='line'>server 101.33.99.66 <span class="o">{</span> keys <span class="o">{</span> TRANSFER; <span class="o">}</span>; <span class="o">}</span>;
</span><span class='line'>
</span><span class='line'>zone <span class="s2">&quot;example1.com&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">type </span>slave;
</span><span class='line'>    file <span class="s2">&quot;slaves/example1.com&quot;</span>;
</span><span class='line'>    allow-transfer <span class="o">{</span> none; <span class="o">}</span>;
</span><span class='line'>    allow-query <span class="o">{</span> any; <span class="o">}</span> ;
</span><span class='line'>    masters <span class="o">{</span> 101.33.99.66; <span class="o">}</span>;
</span><span class='line'>  allow-notify <span class="o">{</span> key secret-key; <span class="o">}</span>;
</span><span class='line'><span class="o">}</span>;
</span><span class='line'>zone <span class="s2">&quot;exampleone.com&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type </span>slave;
</span><span class='line'>  file <span class="s2">&quot;slaves/exampleone.com&quot;</span>;
</span><span class='line'>    masters <span class="o">{</span> 101.33.99.66; <span class="o">}</span>;
</span><span class='line'>  allow-notify <span class="o">{</span> key secret-key; <span class="o">}</span>;
</span><span class='line'>  allow-transfer <span class="o">{</span> none; <span class="o">}</span>;
</span><span class='line'>  allow-query <span class="o">{</span> any; <span class="o">}</span> ;
</span><span class='line'><span class="o">}</span>;
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[empezando con chef]]></title>
    <link href="http://devops-ar.github.com/blog/2012/02/03/empezando-con-chef/"/>
    <updated>2012-02-03T02:20:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/02/03/empezando-con-chef</id>
    <content type="html"><![CDATA[<h1>Componentes de una instalación de Chef</h1>

<p>Una instalación de Chef va a contar típicamente con tres componentes.</p>

<ul>
<li><strong>Chef Server</strong> Es el host donde esta la base de datos de los nodes registrados, los certificados de las credenciales de los mismos y los cookbooks.</li>
<li><strong>Chef Client</strong> Es el node gestionado a través del Chef Server. Una vez hecho el bootstraping, cada vez que se ejecute el cliente de chef (comando chef-client) se conecta al Chef Server, descarga y aplica la configuración establecida por las recetas, roles y environments que tenga asignado.</li>
<li><strong>Workstation</strong> Puede o no ser un node de chef, pero si va tener las credenciales de un usuario registrado con el Chef Server. Desde este equipo se ejecutan comandos de knife y se trabajan con los cookbooks.</li>
</ul>


<h1>Bootstraping</h1>

<p>La instalación de chef en un host (node) para que pueda ser gestionado por un chef server se llama bootstraping. Se realiza con el comando <a href="http://wiki.opscode.com/display/chef/Knife">knife</a> y el subcomando <a href="http://wiki.opscode.com/display/chef/Knife+Bootstrap">bootstrap</a>.</p>

<p>Por ejemplo:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife bootstrap 10.24.2.51 -x osvaldo --sudo  -N unixtools.tx.corp.acme.com -r <span class="s1">&#39;role[demo]&#39;</span> -d rhel5-demo
</span></code></pre></td></tr></table></div></figure>


<p>Con ese comando, se esta ejecutando el comando knife, el subcomando bootstrap, la dirección IP del server que se le va a hacer el bootstrap y los parámetros, que entonces, serán del subcomando.</p>

<pre><code>--sudo:
    El bootstrap se ejecuta via sudo.
-x, --ssh-user USERNAME:
    El username (nombre de usuario) con el que se realiza la conexión ssh.
-N, --node-name NAME:
    El nombre con el que el host va a ser registrado (como un node) en el server Chef. Usamos el fqdn (el node name tiene que ser único).
-r, --run-list RUN_LIST:
    Un listado separado por comas de los roles o recetas que se van a aplicar en el momento del bootstrapping.
-d, --distro DISTRO:
    El template que se va a utilizar para el bootstrap.
</code></pre>

<p>El bootstraping se debe realizar desde la workstation. Los templates del bootstrap son scripts en ruby pero con codigo en bash y se colocan en alguna de las locaciones predeterminadas.</p>

<figure class='code'><figcaption><span>tree ~/chef-repo/.chef</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>|-- bootstrap
</span><span class='line'>|   <span class="sb">`</span>-- glb-rhel5.erb
</span><span class='line'>|-- knife.rb
</span><span class='line'>|-- osvaldo.pem
</span><span class='line'><span class="sb">`</span>-- validation.pem
</span></code></pre></td></tr></table></div></figure>


<p>Una locación común seria ~/chef-repo/.chef. En esta carpeta tenemos:</p>

<ul>
<li><strong>validation.pem</strong>: Es el certificado que utilizan los nodes para validarse ante el Chef Server</li>
<li><strong>osvaldo.pem</strong>: Certificado del cliente. Lo utiliza el operador para trabajar desde ese host como workstation.</li>
<li><strong>knife.rb</strong>: Archivo de configuración del comando knife.</li>
<li><strong>bootstrap</strong>: Directorio donde se almacenan los templates para el bootstrap.</li>
<li><strong>glb-rhel5.rb</strong>: Template para la instalación de un servidor RedHat (CentOS) de ACME.</li>
</ul>


<figure class='code'><figcaption><span>bootstrap/glb-rhel5.erb </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">bash</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">echo &lt;%= @config[:chef_node_name] %&gt; &gt; /tmp/chef_node_name</span>
</span><span class='line'>
</span><span class='line'><span class="s1">PROPERHOSTNAME=`cat /tmp/chef_node_name | cut -d. -f1`</span>
</span><span class='line'><span class="s1">PROPERDNSDOMAINNAME=`cat /tmp/chef_node_name | sed s/^$PROPERHOSTNAME.//` </span>
</span><span class='line'>
</span><span class='line'><span class="s1">IPV4ADDR=`/sbin/ip addr | grep eth0 | grep &quot;inet &quot; | cut -d &quot; &quot; -f 6 | cut -d \/ -f 1`</span>
</span><span class='line'>
</span><span class='line'><span class="s1">cp /etc/hosts /etc/hosts.chef-bck</span>
</span><span class='line'>
</span><span class='line'><span class="s1">NETCONF=&quot;/etc/sysconfig/network&quot;</span>
</span><span class='line'><span class="s1">grep &quot;^HOSTNAME=${PROPERHOSTNAME}$&quot; ${NETCONF} || ( sed -i s/^HOSTNAME.*$// ${NETCONF} &amp;&amp; echo &quot;HOSTNAME=${PROPERHOSTNAME}&quot; &gt;&gt; ${NETCONF})</span>
</span><span class='line'>
</span><span class='line'><span class="s1">(</span>
</span><span class='line'><span class="s1">cat &lt;&lt;EOF</span>
</span><span class='line'><span class="s1">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span>
</span><span class='line'><span class="s1">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span>
</span><span class='line'><span class="s1">${IPV4ADDR} ${PROPERHOSTNAME}.${PROPERDNSDOMAINNAME} ${PROPERHOSTNAME}</span>
</span><span class='line'><span class="s1">EOF</span>
</span><span class='line'><span class="s1">) &gt; /etc/hosts</span>
</span><span class='line'>
</span><span class='line'><span class="s1">hostname $PROPERHOSTNAME</span>
</span><span class='line'>
</span><span class='line'><span class="s1">if [ ! -d /usr/local/rvm ]; then</span>
</span><span class='line'><span class="s1">    wget http://192.168.20.50/rvm-chef-0.10.4-r0.noarch.rpm -P /tmp</span>
</span><span class='line'><span class="s1">    rpm -ivh /tmp/rvm-chef-0.10.4-r0.noarch.rpm</span>
</span><span class='line'><span class="s1">fi</span>
</span><span class='line'>
</span><span class='line'><span class="s1">(</span>
</span><span class='line'><span class="s1">cat &lt;&lt;&#39;</span><span class="no">EOP</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">[[ -s &quot;/usr/local/rvm/scripts/rvm&quot; ]] &amp;&amp; . &quot;/usr/local/rvm/scripts/rvm&quot; </span>
</span><span class='line'><span class="s1">EOP</span>
</span><span class='line'><span class="s1">) &gt;&gt; .bashrc</span>
</span><span class='line'><span class="s1">[[ -s &quot;/usr/local/rvm/scripts/rvm&quot; ]] &amp;&amp; . &quot;/usr/local/rvm/scripts/rvm&quot; </span>
</span><span class='line'><span class="s1">rvm use --default ruby-1.9.2</span>
</span><span class='line'>
</span><span class='line'><span class="s1">mkdir -p /etc/chef</span>
</span><span class='line'>
</span><span class='line'><span class="s1">(</span>
</span><span class='line'><span class="s1">cat &lt;&lt;&#39;</span><span class="no">EOP</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">&lt;%= validation_key %&gt;</span>
</span><span class='line'><span class="s1">EOP</span>
</span><span class='line'><span class="s1">) &gt; /tmp/validation.pem</span>
</span><span class='line'><span class="s1">awk NF /tmp/validation.pem &gt; /etc/chef/validation.pem</span>
</span><span class='line'><span class="s1">rm /tmp/validation.pem</span>
</span><span class='line'>
</span><span class='line'><span class="s1">(</span>
</span><span class='line'><span class="s1">cat &lt;&lt;&#39;</span><span class="no">EOP</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">&lt;%= config_content %&gt;</span>
</span><span class='line'><span class="s1">EOP</span>
</span><span class='line'><span class="s1">) &gt; /etc/chef/client.rb</span>
</span><span class='line'>
</span><span class='line'><span class="s1">(</span>
</span><span class='line'><span class="s1">cat &lt;&lt;&#39;</span><span class="no">EOP</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">&lt;%= { &quot;run_list&quot; =&gt; @run_list }.to_json %&gt;</span>
</span><span class='line'><span class="s1">EOP</span>
</span><span class='line'><span class="s1">) &gt; /etc/chef/first-boot.json</span>
</span><span class='line'>
</span><span class='line'><span class="s1">chef-client -j /etc/chef/first-boot.json&#39;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[guia rapida de git para equipos]]></title>
    <link href="http://devops-ar.github.com/blog/2012/02/03/guia-rapida-de-git-para-equipos/"/>
    <updated>2012-02-03T01:54:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/02/03/guia-rapida-de-git-para-equipos</id>
    <content type="html"><![CDATA[<h2>¿Quien soy?</h2>

<p>Si se ejecuta <code>git config -l</code> deberia obtenerse algo asi.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git config -l
</span><span class='line'>user.name<span class="o">=</span>Osvaldo
</span><span class='line'>user.email<span class="o">=</span>osvaldo@example.com
</span></code></pre></td></tr></table></div></figure>


<p>Si no hemos configurado aun git, empecemos por ahi.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git config --global user.email <span class="s2">&quot;osvaldo@example.com&quot;</span>
</span><span class='line'>git config --global user.name <span class="s2">&quot;Osvaldo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Crear un repo</h2>

<p>Se puede crear un repositorio nuevo</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git init
</span></code></pre></td></tr></table></div></figure>


<p>o se puede clonar un ya existente</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git clone ssh://192.168.20.52/home/osvaldo/chef-repo .
</span></code></pre></td></tr></table></div></figure>


<h2>Branches</h2>

<p>Una branch puede ser creado por un próposito definido (arreglar un bug, <a href="http://nvie.com/posts/a-successful-git-branching-model/">introducir una nueva funcionalidad</a>. También puede ser por usuario. De esta manera, cada uno tiene su branch, donde puede realizar las modificaciones sin afectar el trabajo que estén haciendo otros. Una vez el código esta listo para producción, se hace el merge a la branch master (<a href="http://kentnguyen.com/development/visualized-git-practices-for-team/">haciendo primero un <code>git pull -rebase</code></a>).</p>

<h2>Flujo de trabajo</h2>

<p>El flujo de trabajo con las branches seria</p>

<ul>
<li>configurar git</li>
<li>clonar el repo <code>git fetch</code></li>
<li>crear/moverme a la branch personal <code>git checkout -b otsuarez</code></li>
<li>editar <code>git -m -a ".. cambios .."</code> (nota. en la branch personal: &#8220;otsuarez&#8221;).</li>
<li>cambiar a la branch principal y copiar los cambios para ahi <code>git checkout master</code> y despues <code>git merge otsuarez</code></li>
<li>actualizar el repo central. <code>git push origin master</code></li>
<li>opcionalmente podemos borrar la rama creada <code>git branch -D otsuarez</code></li>
</ul>


<h3>Referencias</h3>

<ul>
<li><a href="http://www.spheredev.org/wiki/Git_for_the_lazy">http://www.spheredev.org/wiki/Git_for_the_lazy</a></li>
<li><a href="http://help.github.com/git-cheat-sheets/">http://help.github.com/git-cheat-sheets/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[instalando graylog2]]></title>
    <link href="http://devops-ar.github.com/blog/2012/01/02/manejando-trazas/"/>
    <updated>2012-01-02T15:43:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2012/01/02/manejando-trazas</id>
    <content type="html"><![CDATA[<h2>Elasticsearch</h2>

<p>Primero necesitamos instalar elasticsearch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /opt
</span><span class='line'><span class="c"># Elasticsearch :</span>
</span><span class='line'><span class="nv">ES_PACKAGE</span><span class="o">=</span>elasticsearch-0.18.6.zip <span class="c"># Latest release as of publishing.</span>
</span><span class='line'><span class="nv">ES_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">ES_PACKAGE</span><span class="p">%%.zip</span><span class="k">}</span>
</span><span class='line'><span class="nv">SITE</span><span class="o">=</span>http://github.com/downloads/elasticsearch/elasticsearch
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;$ES_DIR&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
</span><span class='line'><span class="k">  </span>wget --no-check-certificate <span class="nv">$SITE</span>/<span class="nv">$ES_PACKAGE</span>
</span><span class='line'>  unzip <span class="nv">$ES_PACKAGE</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>ln -s  <span class="nv">$ES_DIR</span> elasticsearch
</span><span class='line'><span class="nb">cd </span>elasticsearch
</span><span class='line'><span class="c"># se puede utilizar -f para mantener en foreground</span>
</span><span class='line'>./bin/elasticsearch
</span></code></pre></td></tr></table></div></figure>


<h2>Graylog2</h2>

<h3>requerimientos</h3>

<p>Sobre CentOS necesitamos adicionar el repo</p>

<figure class='code'><figcaption><span>/etc/yum.repos.d/10gen.repo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[10gen]</span>
</span><span class='line'><span class="na">name</span><span class="o">=</span><span class="s">10gen Repository</span>
</span><span class='line'><span class="na">baseurl</span><span class="o">=</span><span class="s">http://downloads-distro.mongodb.org/repo/redhat/os/i686</span>
</span><span class='line'><span class="na">gpgcheck</span><span class="o">=</span><span class="s">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instalamos el paquete.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install mongo-10gen-server
</span></code></pre></td></tr></table></div></figure>


<p>Los siguientes pasos serian:
- Editar el archivo de configuración
- Iniciar el servicio
- Crear un usuario
- Reiniciar el servicio</p>

<p>La configuración del servicio de mongodb.</p>

<figure class='code'><figcaption><span>/etc/mongod.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="na">port</span> <span class="o">=</span> <span class="s">27017</span>
</span><span class='line'><span class="na">auth</span> <span class="o">=</span> <span class="s">true</span>
</span><span class='line'><span class="na">nohttpinterface</span> <span class="o">=</span> <span class="s">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Iniciar el servicio.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/init.d/mongod start
</span></code></pre></td></tr></table></div></figure>


<p>Crear las credenciales.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo mongo
</span><span class='line'>use graylog2
</span><span class='line'>db.addUser<span class="o">(</span><span class="s2">&quot;perez&quot;</span>, <span class="s2">&quot;justsomepAss&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reiniciar el servicio para activar las credenciales declaradas.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/init.d/mongod restart
</span></code></pre></td></tr></table></div></figure>


<p>El servidor de Graylog2 requiere que se instale openjdk.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install java-1.6.0-openjdk apr-devel apr-util-devel httpd-devel  curl-devel  zlib-devel gcc-c++
</span><span class='line'><span class="c"># make autoconf openssl-devel readline-devel expat-devel gettext-devel gcc </span>
</span></code></pre></td></tr></table></div></figure>


<h2>graylog2 server</h2>

<p>Primero probamos con 0.9.5 &#8230;.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">GSF</span><span class="o">=</span><span class="s2">&quot;graylog2-server-0.9.5p1.tar.gz&quot;</span>
</span><span class='line'><span class="nv">GSD</span><span class="o">=</span><span class="k">${</span><span class="nv">GSF</span><span class="p">%%.tar.gz</span><span class="k">}</span>
</span><span class='line'>wget https://github.com/downloads/Graylog2/graylog2-server/<span class="nv">$GSF</span> --no-check-certificate -P /tmp
</span><span class='line'><span class="nb">cd</span> /opt/
</span><span class='line'>rm -f graylog2-server
</span><span class='line'>tar zxf /tmp/<span class="nv">$GSF</span>
</span><span class='line'>ln -s <span class="nv">$GSD</span> graylog2-server
</span><span class='line'>rm -f /tmp/<span class="nv">$GSF</span>
</span><span class='line'>cp graylog2-server/graylog2.conf.example /etc/graylog2.conf
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># download graylog2 from https://github.com/Graylog2/graylog2-server/downloads</span>
</span><span class='line'><span class="nb">cd</span> /tmp
</span><span class='line'>wget https://github.com/downloads/Graylog2/graylog2-server/graylog2-server-0.9.6-beta.tar.gz --no-check-certificate
</span><span class='line'><span class="nb">cd</span> /opt/
</span><span class='line'>tar zxf /tmp/graylog2-server-0.9.6-beta.tar.gz
</span><span class='line'>ln -s graylog2-server-0.9.6-beta graylog2-server
</span><span class='line'>cp graylog2-server/graylog2.conf.example /etc/graylog2.conf
</span><span class='line'>
</span><span class='line'>/etc/graylog2.conf
</span><span class='line'><span class="nv">mongodb_user</span> <span class="o">=</span> perez
</span><span class='line'><span class="nv">mongodb_password</span> <span class="o">=</span> justsomepAss
</span><span class='line'><span class="c"># por ahora no toco el syslog udp port </span>
</span><span class='line'>
</span><span class='line'>sed -i <span class="s1">&#39;s/mongodb_user = grayloguser/mongodb_user = perez/&#39;</span> /etc/graylog2.conf
</span><span class='line'>sed -i <span class="s1">&#39;s/mongodb_password = 123/mongodb_password = justsomepAss/&#39;</span> /etc/graylog2.conf
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">cd</span> /opt/graylog2-server/bin/
</span><span class='line'><span class="c">#java -Djava.net.preferIPv4Stack=true -jar /opt/graylog2-server/graylog2-server.jar </span>
</span><span class='line'>sed -i <span class="s1">&#39;s/java -jar/java  -Djava.net.preferIPv4Stack=true -jar/&#39;</span> graylog2ctl
</span><span class='line'>./graylog2ctl start
</span></code></pre></td></tr></table></div></figure>


<h2>graylog2-web-interface</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>adduser -m graylog
</span><span class='line'>wget https://github.com/downloads/Graylog2/graylog2-web-interface/graylog2-web-interface-0.9.5p2.tar.gz  --no-check-certificate -P /tmp
</span><span class='line'><span class="nb">cd</span> /opt
</span><span class='line'>tar zxf /tmp/graylog2-web-interface-0.9.5p2.tar.gz
</span><span class='line'>rm -f  graylog2-web-interface
</span><span class='line'>ln -s graylog2-web-interface-0.9.5p2 graylog2-web-interface
</span><span class='line'>chown -R graylog /opt/graylog2-web-interface-0.9.5p2
</span><span class='line'><span class="nb">cd</span> /opt/graylog2-web-interface
</span><span class='line'>
</span><span class='line'>gem install bundler
</span><span class='line'>bundle install
</span><span class='line'>
</span><span class='line'>vi /opt/graylog2-web-interface/config/<span class="o">{</span>email.yml,general.yml,mongoid.yml<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>/opt/graylog2-web-interface/config/email.yml
</span><span class='line'>sed -i <span class="s1">&#39;s/host: smtp.example.org/host: localhost/&#39;</span> /opt/graylog2-web-interface/config/email.yml
</span><span class='line'><span class="c">#sed -i &#39;s///&#39;</span>
</span><span class='line'>sed -i <span class="s1">&#39;s/enable_starttls_auto: true/enable_starttls_auto: false/&#39;</span> /opt/graylog2-web-interface/config/email.yml
</span><span class='line'><span class="nv">$HOSTNAME</span><span class="o">=</span><span class="sb">`</span>hostname -f<span class="sb">`</span>
</span><span class='line'>sed -i <span class="s1">&#39;s/external_hostname: &quot;your-graylog2.example.org&quot;/external_hostname: &quot;${HOSTNAME}&quot;/&#39;</span> /opt/graylog2-web-interface/config/general.yml
</span><span class='line'><span class="c"># manually edited mongoid.yml</span>
</span><span class='line'>sed -i <span class="s1">&#39;1,6s/^/#/&#39;</span> /opt/graylog2-web-interface/config/mongoid.yml
</span><span class='line'>sed -i <span class="s1">&#39;8,$ s/^#//&#39;</span> /opt/graylog2-web-interface/config/mongoid.yml
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">cd</span> /opt/graylog2-web-interface
</span><span class='line'>mkdir tmp log
</span><span class='line'>chmod -R 777 tmp log
</span><span class='line'>
</span><span class='line'>gem install passenger
</span></code></pre></td></tr></table></div></figure>


<p>Una vez que haya terminado la instalación, se muestra un mensaje similar al siguiente.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>The Apache 2 module was successfully installed.
</span><span class='line'>
</span><span class='line'>Please edit your Apache configuration file, and add these lines:
</span><span class='line'>
</span><span class='line'>   LoadModule passenger_module /usr/local/rvm/gems/ruby-1.9.2-p290/gems/passenger-3.0.11/ext/apache2/mod_passenger.so
</span><span class='line'>   PassengerRoot /usr/local/rvm/gems/ruby-1.9.2-p290/gems/passenger-3.0.11
</span><span class='line'>   PassengerRuby /usr/local/rvm/wrappers/ruby-1.9.2-p290/ruby
</span><span class='line'>
</span><span class='line'>After you restart Apache, you are ready to deploy any number of Ruby on Rails
</span><span class='line'>applications on Apache, without any further Ruby on Rails-specific
</span><span class='line'>configuration!
</span><span class='line'>
</span><span class='line'>Press ENTER to <span class="k">continue</span>.
</span></code></pre></td></tr></table></div></figure>


<p>Configuramos apache. Primero el módulo.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cat &gt; /etc/httpd/conf.d/passenger.conf <span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span class='line'><span class="s">LoadModule passenger_module /usr/local/rvm/gems/ruby-1.9.2-p290/gems/passenger-3.0.11/ext/apache2/mod_passenger.so</span>
</span><span class='line'><span class="s">PassengerRoot /usr/local/rvm/gems/ruby-1.9.2-p290/gems/passenger-3.0.11</span>
</span><span class='line'><span class="s">PassengerRuby /usr/local/rvm/wrappers/ruby-1.9.2-p290/ruby</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Despues creamos la declaración para el host virtual.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">HOSTNAME</span><span class="o">=</span>unixtools.example.com
</span><span class='line'>cat &gt; /etc/httpd/vhost.d/unixtools.conf <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">&lt;VirtualHost *:80&gt;</span>
</span><span class='line'><span class="s">  ServerName ${HOSTNAME}</span>
</span><span class='line'><span class="s">  DocumentRoot /opt/graylog2-web-interface/public</span>
</span><span class='line'><span class="s">  &lt;Directory /opt/graylog2-web-interface/public&gt;</span>
</span><span class='line'><span class="s">     AllowOverride all</span>
</span><span class='line'><span class="s">     Options -MultiViews</span>
</span><span class='line'><span class="s">  &lt;/Directory&gt;</span>
</span><span class='line'><span class="s">&lt;/VirtualHost&gt;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>sending a test message</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">  &quot;host&quot;:&quot;192.168.0.3&quot;,</span>
</span><span class='line'><span class="s1">  &quot;version&quot;:&quot;1.0&quot;,</span>
</span><span class='line'><span class="s1">  &quot;facility&quot;:&quot;testing&quot;,</span>
</span><span class='line'><span class="s1">  &quot;short_message&quot;:&quot;testing gelf message&quot;</span>
</span><span class='line'><span class="s1">}&#39;</span> | gzip -f - | nc -u localhost 12201
</span></code></pre></td></tr></table></div></figure>


<p>Si este error aparece.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FATAL: org.graylog2.Main - Could not start syslog server core thread. Do you have permissions to listen on port 514?
</span></code></pre></td></tr></table></div></figure>


<p>El problema puede ser que no este escuchando el graylog2 server en ese puerto, pues ya estaba escuchando el syslog.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@unixtools bin<span class="o">]</span><span class="c"># netstat -ntapul | grep 514</span>
</span><span class='line'>udp        0      0 0.0.0.0:514                 0.0.0.0:*                               2670/syslogd
</span><span class='line'><span class="o">[</span>root@unixtools bin<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>La solución es cambiar el syslog para otro puerto. Algo poco intuitivo pues la única forma de cambiar el puerto por el que escucha el syslogd (en CentOS al menos) es cambiando la definición del puerto utilizado por syslog en el archivo /etc/services <a href="http://community.zenoss.org/docs/DOC-4553">http://community.zenoss.org/docs/DOC-4553</a>.
Se sugiere comentarear la línea original y adicionar otra con la nueva definición.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#syslog     514/udp                   # original syslog setting</span>
</span><span class='line'>syslog      10514/udp                 <span class="c"># setting to accomodate zenoss</span>
</span></code></pre></td></tr></table></div></figure>


<p>Comprobar que el syslog esta escuchando en el nuevo puerto.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@unixtools bin<span class="o">]</span><span class="c"># netstat -ntapul | grep 514</span>
</span><span class='line'>udp        0      0 0.0.0.0:10514               0.0.0.0:*                               32276/syslogd
</span><span class='line'><span class="o">[</span>root@unixtools bin<span class="o">]</span><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>Ya se puede lanzar el proceso de graylog2.</p>

<h3>Centralized logging</h3>

<p>Probando logstash  &#8230;</p>

<p>http://logstash.net/docs/1.0.17/getting-started-centralized</p>

<p>http://semicomplete.com/files/logstash/logstash-1.0.17-monolithic.jar</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">input</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">file</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;syslog&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">#</span> <span class="nx">Wildcards</span> <span class="nx">work</span> <span class="nx">here</span> <span class="o">:</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">path</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s2">&quot;/var/log/messages&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/log/syslog&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/log/*.log&quot;</span> <span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">file</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache-access&quot;</span>
</span><span class='line'>    <span class="nx">path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/var/log/apache2/access.log&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">file</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache-error&quot;</span>
</span><span class='line'>    <span class="nx">path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/var/log/apache2/error.log&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">output</span> <span class="p">{</span>
</span><span class='line'>  <span class="err">#</span> <span class="nx">Output</span> <span class="nx">events</span> <span class="nx">to</span> <span class="nx">stdout</span> <span class="k">for</span> <span class="nx">debugging</span><span class="p">.</span> <span class="nx">Feel</span> <span class="nx">free</span> <span class="nx">to</span> <span class="nx">remove</span>
</span><span class='line'>  <span class="err">#</span> <span class="k">this</span> <span class="nx">output</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">don</span><span class="err">&#39;</span><span class="nx">t</span> <span class="nx">need</span> <span class="nx">it</span><span class="p">.</span>
</span><span class='line'>  <span class="nx">stdout</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Se puede utilizar.</p>

<ul>
<li>gelf://yourgraylog2server:port   # ship logs to the graylog2 server <a href="http://weboperations.blogspot.com/2011/04/fwd-non-intrusive-way-to-send-messages.html">http://weboperations.blogspot.com/2011/04/fwd-non-intrusive-way-to-send-messages.html</a>.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">java</span> <span class="o">-</span><span class="nx">jar</span> <span class="nx">logstash</span><span class="o">-</span><span class="mf">1.0</span><span class="p">.</span><span class="mi">17</span><span class="o">-</span><span class="nx">monolithic</span><span class="p">.</span><span class="nx">jar</span> <span class="nx">agent</span> <span class="o">-</span><span class="nx">f</span> <span class="nx">stash</span><span class="p">.</span><span class="nx">conf</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Exception</span> <span class="k">in</span> <span class="nx">thread</span> <span class="s2">&quot;main&quot;</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">UnsupportedClassVersionError</span><span class="o">:</span> <span class="nx">Bad</span> <span class="nx">version</span> <span class="nx">number</span> <span class="k">in</span> <span class="p">.</span><span class="kr">class</span> <span class="nx">file</span>
</span></code></pre></td></tr></table></div></figure>


<p>Este error aparece cuando se compila un archivo .java con una version de JDK y se ejecuta el archivo .class con una versión diferente de JVM.</p>

<p>Confundido? Pudiera pensar, la misma versión no es necesaria para compilar y para ejecutar.</p>

<p>Correcto, esta en lo cierto. Pero no puede ejecutar archivos .class que fueron compilados con una versión mas actual que la JVM que esta utilizando.</p>

<p>En este caso, la versión de openjdk que instaló el CentOS era anterior a la versión de JDK con que fue compilado el jar del logstash. <a href="https://github.com/logstash/logstash/wiki/Building-and-running-logstash-from-source">https://github.com/logstash/logstash/wiki/Building-and-running-logstash-from-source</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Prerequisites</span>
</span><span class='line'><span class="nx">Sun</span> <span class="nx">Java</span> <span class="mi">6</span> <span class="nx">JDK</span> <span class="p">(</span><span class="nx">don</span><span class="err">&#39;</span><span class="nx">t</span> <span class="k">try</span> <span class="k">this</span> <span class="kd">with</span> <span class="nx">openjdk</span><span class="p">)</span>
</span><span class='line'><span class="nx">JRuby</span> <span class="nx">version</span> <span class="nx">that</span> <span class="nx">matches</span> <span class="nx">what</span> <span class="nx">logstash</span> <span class="nx">uses</span> <span class="p">(</span><span class="nx">You</span> <span class="nx">can</span> <span class="nx">get</span> <span class="k">this</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">top</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">Makefile</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>not a good choice for legacy servers &#8230;.</p>

<h3>syslog using ruby</h3>

<figure class='code'><figcaption><span>hi.rb </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;syslog&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># $0 is the current script name</span>
</span><span class='line'>  <span class="no">Syslog</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="vg">$0</span><span class="p">,</span> <span class="no">Syslog</span><span class="o">::</span><span class="no">LOG_PID</span> <span class="o">|</span> <span class="no">Syslog</span><span class="o">::</span><span class="no">LOG_CONS</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">warning</span> <span class="n">message</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">log</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Comprobando que funciona</h3>

<p>A GELF message is a GZIP&#8217;d or ZLIB&#8217;d JSON string with the following fields: &#8230;
Un mensaje GELF es una cadena JSON compactada con GZIP o ZLIB &#8230;
<a href="https://github.com/Graylog2/graylog2-docs/wiki/GELF">https://github.com/Graylog2/graylog2-docs/wiki/GELF</a></p>

<p>Esa la razón por la cual se utiliza el gzip en el comando:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">  &quot;host&quot;:&quot;192.168.0.3&quot;,</span>
</span><span class='line'><span class="s1">  &quot;version&quot;:&quot;1.0&quot;,</span>
</span><span class='line'><span class="s1">  &quot;facility&quot;:&quot;testing&quot;,</span>
</span><span class='line'><span class="s1">  &quot;short_message&quot;:&quot;testing gelf message&quot;</span>
</span><span class='line'><span class="s1">}&#39;</span> | gzip -f - | nc -u localhost 12201
</span></code></pre></td></tr></table></div></figure>


<p>deberiamos ver esto:</p>

<figure class='code'><figcaption><span>/var/log/messages</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>2011-12-22 16:56:01,186 DEBUG: org.graylog2.messagehandlers.gelf.GELFClientHandlerThread - Received message is not chunked. Handling now.
</span><span class='line'>2011-12-22 16:56:01,189 DEBUG: org.graylog2.messagehandlers.gelf.SimpleGELFClientHandler - Handling GZIP compressed SimpleGELFClient
</span><span class='line'>2011-12-22 16:56:01,326 DEBUG: org.graylog2.messagehandlers.gelf.SimpleGELFClientHandler - Got GELF message: shortMessage: testing gelf message | fullMessage: null | level: 1 | host: 192.168.0.3 | file: null | line: -1 | facility: testing | version: 1.0 | additional: 0
</span><span class='line'>2011-12-22 16:56:01,410 INFO : org.graylog2.periodical.BulkIndexerThread - About to index max 4000 messages. You have a total of 1 messages in the queue. <span class="o">[</span>freq:1s<span class="o">]</span>
</span><span class='line'>2011-12-22 16:56:01,411 DEBUG: org.graylog2.messagequeue.MessageQueue - Read 1 messages from queue.
</span><span class='line'>2011-12-22 16:56:01,411 INFO : org.graylog2.periodical.BulkIndexerThread - ... indexing 1 messages.
</span></code></pre></td></tr></table></div></figure>


<h3>Referencias</h3>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[creating an rpm package from on tgz file]]></title>
    <link href="http://devops-ar.github.com/blog/2011/12/17/creating-an-rpm-package-from-on-a-tgz-file/"/>
    <updated>2011-12-17T15:26:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2011/12/17/creating-an-rpm-package-from-on-a-tgz-file</id>
    <content type="html"><![CDATA[<p><em>disclaimer: this is only for creating an rpm for installing a set of files, no compiling, just a bunch of file being copied into a server.</em></p>

<p>Starting from a tgz file, an rpm package will be created. Sometimes, a tgz file is quicker/easier to use. However, in the long run, sticking to a package management system for handling the installation of applications on a system will pay off for sure.</p>

<p>Creating an rpm package from a tgz file isn&#8217;t that hard as it&#8217;s shown below.</p>

<h3>setting up rpm build environment</h3>

<p>Let&#8217;s start by setting a dev environment, also, setting some variables which will be handly at the rpm creation process.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo yum install rpm-build
</span><span class='line'>mkdir -p ~/rpm/<span class="o">{</span>BUILD,RPMS,SOURCES,SRPMS,SPECS,tmp<span class="o">}</span>
</span><span class='line'>mkdir ~/rpm/RPMS/<span class="o">{</span>i386,i586,i686,noarch<span class="o">}</span>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;%packager Osvaldo &lt;osvaldo@devops.com.ar&gt;&#39;</span> &gt;
</span><span class='line'>~/.rpmmacros
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;%_topdir %(echo $HOME)/rpm&#39;</span> &gt;&gt; ~/.rpmmacros
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;%_tmppath %(echo $HOME)/rpm/tmp&#39;</span> &gt;&gt; ~/.rpmmacros
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;%_query_all_fmt %%{name}-%%{version}-%%{release}.%%{arch}&quot;</span> &gt;&gt;
</span><span class='line'>~/.rpmmacros
</span></code></pre></td></tr></table></div></figure>


<p>Since we&#8217;re be creating an rpm file just for installing a set of already existing files, it will only be needed three steps.</p>

<ol>
<li>First to place all of the files to be included on the rpm file under a directory in the BUILD directory.</li>
<li>Second, to create the spec file</li>
<li>and last, to execute the rpmbuild command.</li>
</ol>


<h3>using yum commands</h3>

<p>Here, commands are shown for how to search for the file and to install the package.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>-bash-3.2<span class="nv">$ </span>yum search glassfish
</span><span class='line'>Loaded plugins: downloadonly, <span class="nv">fastestmirror</span>
</span><span class='line'><span class="o">=================</span> Matched: <span class="nv">glassfish</span> <span class="o">=================</span>
</span><span class='line'>glassfish-loadbalancer.i386 : Sun GlassFish Enterprise Server Load Balancing Plugin
</span><span class='line'>-bash-3.2<span class="err">$</span>
</span><span class='line'>
</span><span class='line'>-bash-3.2<span class="nv">$ </span>sudo yum install glassfish-loadbalancer
</span><span class='line'>Loaded plugins: downloadonly, fastestmirror
</span><span class='line'>Loading mirror speeds from cached hostfile
</span><span class='line'>* base: mirror.cogentco.com
</span><span class='line'>* epel: mirror.hiwaay.net
</span><span class='line'>* extras: mirror.flhsi.com
</span><span class='line'>* updates: mirrors.igsobe.com
</span><span class='line'>Setting up Install Process
</span><span class='line'>Package glassfish-loadbalancer-2.1.1-r2.i386 already installed and
</span><span class='line'>latest version
</span><span class='line'>Nothing to <span class="k">do</span>
</span><span class='line'>-bash-3.2<span class="err">$</span>
</span><span class='line'>-bash-3.2<span class="nv">$ </span>rpm -qa | grep glassfish
</span><span class='line'>glassfish-loadbalancer-2.1.1-r2.i386
</span><span class='line'>-bash-3.2<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually, the package had been already installed, the process remains the same ;).</p>

<p>Now, instead of wondering how certain file came from, those belonging to this package will be fully identified and accesible (and controllable) via the package management system. For example, now we list exactly which files were installed by that rpm file (try that with a tgz file &#8230; asumming you delete it, well, it wasn&#8217;t needed any more, right? ;)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>-bash-3.2<span class="nv">$ </span>rpm -ql glassfish-loadbalancer
</span><span class='line'>/opt/webserver7/lib/libicudata.so.2
</span><span class='line'>/opt/webserver7/lib/libicui18n.so.2
</span><span class='line'>/opt/webserver7/lib/libicuuc.so.2
</span><span class='line'>/opt/webserver7/lib/libxerces-c.so
</span><span class='line'>/opt/webserver7/plugins/lbplugin/bin/libpassthrough.so
</span><span class='line'>/opt/webserver7/plugins/lbplugin/errorpages/default-error.html
</span><span class='line'>/opt/webserver7/plugins/lbplugin/errorpages/sun-http-lberror.html
</span><span class='line'>/opt/webserver7/plugins/lbplugin/resource/LBPluginDefault_root.res
</span><span class='line'>/opt/webserver7/plugins/lbplugin/resource/LBPlugin_root.res
</span><span class='line'>-bash-3.2<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where that file came from? Just use <code>rpm -qf <filename with full path></code> and you&#8217;ll have the answer (again, try that on an file that came from a tgz file, ah, which tgz file btw ;).</p>

<h3>extracting the files from the rpm package</h3>

<p>Just in case someone needs the tgz file, here&#8217;s how to convert the rpm file into a tgz file (pretty easy this way around ;) and extract it to the final destination as it had been installed using the tgz file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rpm2cpio glassfish-loadbalancer-2.1.1-r1.i386.rpm | cpio -idmv
</span><span class='line'>tar zcf glassfish-loadbalancer-2.1.1-r1.tgz opt/
</span></code></pre></td></tr></table></div></figure>


<h3>Notes</h3>

<p>First time the rpm file was created, during installation the following error showed up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@cpweb1 i386<span class="o">]</span><span class="c"># rpm -i loadbalancer-2.2-1.i386.rpm</span>
</span><span class='line'>error: Failed dependencies:
</span><span class='line'>       libns-httpd40.so is needed by loadbalancer-2.2-1.i386
</span><span class='line'><span class="o">[</span>root@cpweb1 i386<span class="o">]</span><span class="c">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>Interesting thing to know about rpm file creation is, there&#8217;s an automatic dependency resolution process being handled automatically by the package management system. When you first create the rpm file, the included files are checked for dependencies, which are then, declared on the metadata of the rpm file. Then, at installation time, those dependencies are checked and if not already fullfilled, a warning message will show up (like it happened on this case). Usually, this wouldn&#8217;t be a problem, since that  dependency would had been already provided by another installed package or, the yum command will find out which package would satisfy the dependency and suggest to install it. Sadly enough, we were dealing with a mixed scenario, one where manual installation were being done at the same time. This particular dependency had been already been satisfied because of a manually installed package. So the real issue at this point was how to force the package management system into doing something he was created
to avoid in the first place.</p>

<p>Exceptions, while rare, do exists. And good systems are prepared to deal with such situations. <strong>The AutoReqProv</strong> tag is used to control the automatic dependency processing performed when the package is being built. To disable automatic dependency processing, add the following line to the spec file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>AutoReqProv: no
</span></code></pre></td></tr></table></div></figure>


<h3>Files</h3>

<p>In order to automate things (we&#8217;re supposed to be lazy, right? ;) I use ol&#8217; make command, so the following Makefile make my life easier. I do rpm work on my workstation, then, upload the new packages to the repo server. So, What it takes?: <code>make all</code>.</p>

<figure class='code'><figcaption><span>Makefile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="nf">all</span><span class="o">:</span>
</span><span class='line'>       rpmbuild -ba glassfish-loadbalancer-2.1.1.spec
</span><span class='line'>       sudo cp ../RPMS/i386/glassfish-loadbalancer-2.1.1-r*.i386.rpm /var/www/repo/i386
</span><span class='line'>       sudo createrepo /var/www/repo/i386
</span><span class='line'>       scp ../RPMS/i386/glassfish-loadbalancer-2.1.1-r*.i386.rpm repo.example.com:/var/www/html/centos/5/netsol/i386
</span><span class='line'>       ssh repo.example.com createrepo /var/www/html/centos/5/netsol/i386/
</span><span class='line'>       ssh repo.example.com createrepo /var/www/html/centos/5/netsol/i686/
</span></code></pre></td></tr></table></div></figure>


<p>The spec file used to create the rpm file.</p>

<figure class='code'><figcaption><span>glassfish-loadbalancer-2.1.1.spec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">define name    glassfish-loadbalancer</span>
</span><span class='line'><span class="l-Scalar-Plain">%define version 2.1.1</span>
</span><span class='line'><span class="l-Scalar-Plain">%define release r2</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Summary</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sun GlassFish Enterprise Server Load Balancing Plugin</span>
</span><span class='line'><span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="err">%</span><span class="p-Indicator">{</span><span class="nv">name</span><span class="p-Indicator">}</span>
</span><span class='line'><span class="l-Scalar-Plain">Version</span><span class="p-Indicator">:</span> <span class="err">%</span><span class="p-Indicator">{</span><span class="nv">version</span><span class="p-Indicator">}</span>
</span><span class='line'><span class="l-Scalar-Plain">Release</span><span class="p-Indicator">:</span> <span class="err">%</span><span class="p-Indicator">{</span><span class="nv">release</span><span class="p-Indicator">}</span>
</span><span class='line'><span class="c1">#Copyright: GPL</span>
</span><span class='line'><span class="l-Scalar-Plain">Group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ACME/Networking/Daemons</span>
</span><span class='line'><span class="l-Scalar-Plain">BuildArch</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">i386</span>
</span><span class='line'><span class="c1">#BuildRoot: %{_builddir}/%{name}-%{version}-%{release}</span>
</span><span class='line'><span class="l-Scalar-Plain">BuildRoot</span><span class="p-Indicator">:</span> <span class="err">%</span><span class="p-Indicator">{</span><span class="nv">_builddir</span><span class="p-Indicator">}</span><span class="l-Scalar-Plain">/%{name}-%{version}</span>
</span><span class='line'><span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://www.oracle.com/</span>
</span><span class='line'><span class="l-Scalar-Plain">Distribution</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">whatever</span>
</span><span class='line'><span class="l-Scalar-Plain">Vendor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Oracle</span>
</span><span class='line'><span class="l-Scalar-Plain">Packager</span><span class="p-Indicator">:</span> <span class="err">%</span><span class="p-Indicator">{</span><span class="nv">packager</span><span class="p-Indicator">}</span>
</span><span class='line'><span class="l-Scalar-Plain">Provides</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Load Balancer Plugin</span>
</span><span class='line'><span class="c1">#Requires:</span>
</span><span class='line'><span class="l-Scalar-Plain">AutoReqProv</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">no</span>
</span><span class='line'><span class="l-Scalar-Plain">License</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restricted</span>
</span><span class='line'>
</span><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">description</span>
</span><span class='line'><span class="l-Scalar-Plain">This package contains the  Sun GlassFish Enterprise Server Load</span>
</span><span class='line'><span class="l-Scalar-Plain">Balancing Plugin.</span>
</span><span class='line'>
</span><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">prep</span>
</span><span class='line'><span class="l-Scalar-Plain">exit 0</span>
</span><span class='line'>
</span><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">build</span>
</span><span class='line'><span class="l-Scalar-Plain">exit 0</span>
</span><span class='line'>
</span><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">install</span>
</span><span class='line'><span class="l-Scalar-Plain">exit 0</span>
</span><span class='line'>
</span><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">clean</span>
</span><span class='line'><span class="l-Scalar-Plain">exit 0</span>
</span><span class='line'>
</span><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">files</span>
</span><span class='line'><span class="err">%</span><span class="l-Scalar-Plain">defattr(-,root,root)</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/plugins/lbplugin/bin/libpassthrough.so</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/plugins/lbplugin/errorpages/default-error.html</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/plugins/lbplugin/errorpages/sun-http-lberror.html</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/plugins/lbplugin/resource/LBPluginDefault_root.res</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/plugins/lbplugin/resource/LBPlugin_root.res</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/lib/libicudata.so.2</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/lib/libicui18n.so.2</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/lib/libicuuc.so.2</span>
</span><span class='line'><span class="l-Scalar-Plain">/opt/webserver7/lib/libxerces-c.so</span>
</span></code></pre></td></tr></table></div></figure>


<p>testing with differente spec values</p>

<figure class='code'><figcaption><span>diff loadbalancer-2.2.1.spec glassfish-loadbalancer-2.1.1.spec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'>1,3c1,3
</span><span class='line'>&lt; %define       name    loadbalancer
</span><span class='line'>&lt; %define version       2.2
</span><span class='line'>&lt; %define release       1
</span><span class='line'><span class="gd">---</span>
</span><span class='line'>&gt; %define       name    glassfish-loadbalancer
</span><span class='line'>&gt; %define version       2.1.1
</span><span class='line'>&gt; %define release       r2
</span><span class='line'>10c10
</span><span class='line'>&lt; Group: Amusements/Graphics
</span><span class='line'><span class="gd">---</span>
</span><span class='line'>&gt; Group: Netsol/Networking/Daemons
</span><span class='line'>12c12,13
</span><span class='line'>&lt; BuildRoot: %{_builddir}/%{name}-%{version}.%{release}
</span><span class='line'><span class="gd">---</span>
</span><span class='line'>&gt; #BuildRoot: %{_builddir}/%{name}-%{version}-%{release}
</span><span class='line'>&gt; BuildRoot: %{_builddir}/%{name}-%{version}
</span><span class='line'>18a20
</span><span class='line'>&gt; AutoReqProv: no
</span><span class='line'><span class="gd">-bash-3.2$</span>
</span></code></pre></td></tr></table></div></figure>


<p>the final directory tree (including trash = i mean, dev files, no time for cleaning it up)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>|-- BUILD
</span><span class='line'>|   <span class="sb">`</span>-- glassfish-loadbalancer-2.1.1
</span><span class='line'>|       <span class="sb">`</span>-- opt
</span><span class='line'>|           <span class="sb">`</span>-- webserver7
</span><span class='line'>|               |-- lib
</span><span class='line'>|               |   |-- libicudata.so.2
</span><span class='line'>|               |   |-- libicui18n.so.2
</span><span class='line'>|               |   |-- libicuuc.so.2
</span><span class='line'>|               |   <span class="sb">`</span>-- libxerces-c.so
</span><span class='line'>|               <span class="sb">`</span>-- plugins
</span><span class='line'>|                   <span class="sb">`</span>-- lbplugin
</span><span class='line'>|                       |-- bin
</span><span class='line'>|                       |   <span class="sb">`</span>-- libpassthrough.so
</span><span class='line'>|                       |-- errorpages
</span><span class='line'>|                       |   |-- default-error.html
</span><span class='line'>|                       |   <span class="sb">`</span>-- sun-http-lberror.html
</span><span class='line'>|                       <span class="sb">`</span>-- resource
</span><span class='line'>|                           |-- LBPluginDefault_root.res
</span><span class='line'>|                           <span class="sb">`</span>-- LBPlugin_root.res
</span><span class='line'>|-- RPMS
</span><span class='line'>|   |-- i386
</span><span class='line'>|   |   |-- glassfish-2.1.1-loadbalancer-2.1-1.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1-1.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1.1-r0.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1.1-r1.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1.1-r2.i386.rpm
</span><span class='line'>|   |   <span class="sb">`</span>-- loadbalancer-2.2-1.i386.rpm
</span><span class='line'>|   |-- i586
</span><span class='line'>|   |-- i686|-- BUILD
</span><span class='line'>|   <span class="sb">`</span>-- glassfish-loadbalancer-2.1.1
</span><span class='line'>|       <span class="sb">`</span>-- opt
</span><span class='line'>|           <span class="sb">`</span>-- webserver7
</span><span class='line'>|               |-- lib
</span><span class='line'>|               |   |-- libicudata.so.2
</span><span class='line'>|               |   |-- libicui18n.so.2
</span><span class='line'>|               |   |-- libicuuc.so.2
</span><span class='line'>|               |   <span class="sb">`</span>-- libxerces-c.so
</span><span class='line'>|               <span class="sb">`</span>-- plugins
</span><span class='line'>|                   <span class="sb">`</span>-- lbplugin
</span><span class='line'>|                       |-- bin
</span><span class='line'>|                       |   <span class="sb">`</span>-- libpassthrough.so
</span><span class='line'>|                       |-- errorpages
</span><span class='line'>|                       |   |-- default-error.html
</span><span class='line'>|                       |   <span class="sb">`</span>-- sun-http-lberror.html
</span><span class='line'>|                       <span class="sb">`</span>-- resource
</span><span class='line'>|                           |-- LBPluginDefault_root.res
</span><span class='line'>|                           <span class="sb">`</span>-- LBPlugin_root.res
</span><span class='line'>|-- RPMS
</span><span class='line'>|   |-- i386
</span><span class='line'>|   |   |-- glassfish-2.1.1-loadbalancer-2.1-1.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1-1.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1.1-r0.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1.1-r1.i386.rpm
</span><span class='line'>|   |   |-- glassfish-loadbalancer-2.1.1-r2.i386.rpm
</span><span class='line'>|   |   <span class="sb">`</span>-- loadbalancer-2.2-1.i386.rpm
</span><span class='line'>|   |-- i586
</span><span class='line'>|   |-- i686
</span><span class='line'>|   <span class="sb">`</span>-- noarch
</span><span class='line'>|-- SOURCES
</span><span class='line'>|-- SPECS
</span><span class='line'>|   |-- Makefile
</span><span class='line'>|   |-- glassfish-loadbalancer-2.1.1.spec
</span><span class='line'>|   <span class="sb">`</span>-- loadbalancer-2.2.1.spec
</span><span class='line'>|-- SRPMS
</span><span class='line'>|   |-- glassfish-2.1.1-loadbalancer-2.1-1.src.rpm
</span><span class='line'>|   |-- glassfish-loadbalancer-2.1-1.src.rpm
</span><span class='line'>|   |-- glassfish-loadbalancer-2.1.1-r0.src.rpm
</span><span class='line'>|   |-- glassfish-loadbalancer-2.1.1-r1.src.rpm
</span><span class='line'>|   |-- glassfish-loadbalancer-2.1.1-r2.src.rpm
</span><span class='line'>|   <span class="sb">`</span>-- loadbalancer-2.2-1.src.rpm
</span><span class='line'><span class="sb">`</span>-- tmp
</span><span class='line'>
</span><span class='line'>19 directories, 24 files
</span></code></pre></td></tr></table></div></figure>


<h3>Some handy links</h3>

<ul>
<li><a href="http://www.lamolabs.org/blog/164/centos-rpm-tutorial-1/">http://www.lamolabs.org/blog/164/centos-rpm-tutorial-1/</a></li>
<li><a href="http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment">http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment</a></li>
<li><a href="http://wiki.centos.org/TipsAndTricks/YumAndRPM">http://wiki.centos.org/TipsAndTricks/YumAndRPM</a></li>
<li><a href="http://ramblings.narrabilis.com/wp/creating-a-yum-repository-repo-and-creating-a-yum-group-to-install-kickstart/">http://ramblings.narrabilis.com/wp/creating-a-yum-repository-repo-and-creating-a-yum-group-to-install-kickstart/</a></li>
<li><a href="http://www.tim-riemenschneider.de/linux/rpmbook/node310.html">http://www.tim-riemenschneider.de/linux/rpmbook/node310.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Herramientas de Chef]]></title>
    <link href="http://devops-ar.github.com/blog/2011/12/17/chef-tools/"/>
    <updated>2011-12-17T14:07:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2011/12/17/chef-tools</id>
    <content type="html"><![CDATA[<p>Este artículo se puede visualizar en formato de presentación <a href="http://devops-ar.github.com/talks/chef/chef-tools.html">aquí</a>.</p>

<h2><a href="http://wiki.opscode.com/display/chef/Ohai">ohai</a></h2>

<p>Ohai detecta información acerca del sistema operativo. Puede ser utilizado como un comando independiente pero su función primaria consiste en proveer información sobre el Nodo a Chef.
Cuando se ejecuta, recolecta información detallada y extensible acerca del equipo sobre el esta corriendo, como por ejemplo, configuración de Chef, el hostname, el FQDN, la configuración de red, así como datos sobre la memoria, la CPU, la plataforma y el kernel.</p>

<p>Cuando se ejecuta independiente, Ohai imprime un bloque de datos en formato JSON con toda la información que puede obtener del sistema. Cuando se utiliza a través de Chef, ese bloque de datos JSON es enviado al servidor de Chef como atributos &#8220;automáticos&#8221; del Nodo para actualizar la información del mismo que pudiera existir previamente.</p>

<h2><a href="http://wiki.opscode.com/display/chef/Knife">knife</a></h2>

<p>Knife es una poderosa herramienta de linea de comandos (CLI) que forma parte de Chef.
Es utilizada por los administradores para interactuar con la API del Servidor de Chef y con el Repositorio local de Chef. Permite manipular los Nodos, Cookbooks, Roles, Databags, Ambientes, etc. Además, puede ser utilizada para la propia instalación de Chef en nuevos sistemas.</p>

<h2>Ohai</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>osvaldo@vostro:~<span class="nv">$ </span>ohai
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;languages&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;perl&quot;</span>: <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;5.10.1&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;archname&quot;</span>: <span class="s2">&quot;i486-linux-gnu-thread-multi&quot;</span>
</span><span class='line'>    <span class="o">}</span>,
</span><span class='line'>    <span class="s2">&quot;python&quot;</span>: <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;2.6.6&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;builddate&quot;</span>: <span class="s2">&quot;Dec 27 2010, 00:02:40&quot;</span>
</span><span class='line'>    <span class="o">}</span>,
</span><span class='line'>...
</span><span class='line'>  <span class="s2">&quot;kernel&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Linux&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;release&quot;</span>: <span class="s2">&quot;2.6.32-5-686&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;#1 SMP Thu Nov 3 04:23:54 UTC 2011&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;machine&quot;</span>: <span class="s2">&quot;i686&quot;</span>,
</span><span class='line'>...
</span><span class='line'>  <span class="s2">&quot;lsb&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;Debian&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Debian GNU/Linux 6.0.3 (squeeze)&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;release&quot;</span>: <span class="s2">&quot;6.0.3&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;codename&quot;</span>: <span class="s2">&quot;squeeze&quot;</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="s2">&quot;platform&quot;</span>: <span class="s2">&quot;debian&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;platform_version&quot;</span>: <span class="s2">&quot;6.0.3&quot;</span>,
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h2>Knife :: the killer app</h2>

<p>Que pasa si queremos obtener una mirada del estado de los servidores que pertenecen a un rol en particular?</p>

<p><strong>Sort by 5min load average</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>osvaldo@coldplay ~<span class="o">]</span><span class="nv">$ </span>knife ssh -x otoja <span class="s1">&#39;roles:demo&#39;</span>  <span class="s1">&#39;cat /proc/loadavg | awk &quot;{print $2}&quot;&#39;</span> | sort -n -k 2
</span><span class='line'>nirvana.example.com 0.00 0.00 0.00 1/149 16941
</span><span class='line'>stp.example.com 0.00 0.00 0.00 4/182 25165
</span><span class='line'>soundgarden.example.com  0.40 0.10 0.03 1/179 485
</span></code></pre></td></tr></table></div></figure>


<p><strong>Sort by uptime</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>osvaldo@coldplay ~<span class="o">]</span><span class="nv">$ </span>knife ssh -x otoja <span class="s1">&#39;roles:demo&#39;</span> <span class="s1">&#39;uptime&#39;</span> | sort -n -k 4
</span><span class='line'>nirvana.example.com  21:25:39 up 8 days,  6:30,  2 users,  load average: 0.00, 0.00, 0.00
</span><span class='line'>soundgarden.example.com   21:24:04 up 8 days,  9:00,  1 user,  load average: 0.20, 0.08, 0.02
</span><span class='line'>stp.example.com  21:25:39 up 33 days, 10:47,  2 users,  load average: 0.00, 0.00, 0.00
</span></code></pre></td></tr></table></div></figure>


<p><strong>puedo hacer un tail a un archivo al mismo tiempo en todos los servidores con solo un comando?</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife ssh -x otoja <span class="s1">&#39;roles:demo&#39;</span> <span class="s1">&#39;sudo tail -f /var/log/messages&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>y ahora a mirar la pantalla &#8230;</p>

<p><strong>que servidores estan utilizando python 2.*?</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>osvaldo@coldplay ~<span class="o">]</span><span class="nv">$ </span>knife <span class="nb">exec</span> -E <span class="s2">&quot;search(:node, &#39;languages_python_version:2.*&#39;  ).each {|host|  puts host[:fqdn] + &#39; python version: &#39; + host[:languages][:python][:version] }&quot;</span>
</span><span class='line'>soundgarden.example.com python version: 2.4.3
</span><span class='line'>nirvana.example.com python version: 2.4.3
</span><span class='line'>stp.example.com python version: 2.4.3
</span><span class='line'>vostro python version: 2.6.6
</span></code></pre></td></tr></table></div></figure>


<p><strong>cual es el estado de un servicio X (ntp en el ejemplo) en un grupo determinado de servidores (con el role demo)?</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>osvaldo@coldplay ~<span class="o">]</span><span class="nv">$ </span>knife ssh -x otoja -m <span class="s2">&quot;`knife exec -E &quot;</span>search<span class="o">(</span>:node, <span class="s1">&#39;roles:demo&#39;</span><span class="o">)</span>.each <span class="o">{</span>|host| puts host<span class="o">[</span>:fqdn<span class="o">]</span> <span class="o">}</span><span class="s2">&quot; | xargs`&quot;</span> <span class="s1">&#39;/etc/init.d/ntpd status&#39;</span>
</span><span class='line'>stp.example.com ntpd is stopped
</span><span class='line'>soundgarden.example.com  ntpd is stopped
</span><span class='line'>nirvana.example.com ntpd is stopped
</span></code></pre></td></tr></table></div></figure>


<p><strong>que servidores tienen instalado java version 1.*?</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>osvaldo@coldplay ~<span class="o">]</span><span class="nv">$ </span>knife <span class="nb">exec</span> -E <span class="s2">&quot;search(:node, &#39;languages_java_version:1.*&#39;  ).each {|host|  puts host[:fqdn] + &#39; java version: &#39; + host[:languages][:java][:version] }&quot;</span>
</span><span class='line'>toja-lm java version: 1.6.0_18
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introducción rápida a Chef]]></title>
    <link href="http://devops-ar.github.com/blog/2011/12/17/introduccion-rapida-a-chef/"/>
    <updated>2011-12-17T13:19:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2011/12/17/introduccion-rapida-a-chef</id>
    <content type="html"><![CDATA[<p>Este artículo se puede visualizar en formato de presentación <a href="http://devops-ar.github.com/talks/chef/quick-intro.html">aquí</a>.</p>

<h3>Definir problema</h3>

<ul>
<li>crecimiento de la granja de servidores</li>
<li>configuración manual</li>
<li>a mayor numero de servidores, mayor posibilidad de error cuando se utiliza la configuracion manual</li>
<li>baja productividad = pérdida de tiempo</li>
<li>El mantenimiento es reactivo en vez de ser proactivo</li>
<li>Cambios de emergencia pueden comprometer un sistema</li>
</ul>


<h3>Objetivo a lograr</h3>

<ul>
<li>permitir crecimiento horizontal</li>
<li>estar preparados para escalar sin mayores complicaciones</li>
<li>evitar los puntos únicos de falla</li>
<li>trabajo manual</li>
<li>conocimiento compartimentado</li>
<li>manejo sencillo de configuraciones complicadas</li>
</ul>


<h3>Beneficio de la solución</h3>

<ul>
<li>organización del trabajo</li>
<li>obliga a una separación de los entornos de trabajo</li>
<li>fuerza a evitar las excepciones</li>
<li>incremento de la productividad</li>
<li>documentación</li>
</ul>


<h3>Herramientas</h3>

<ul>
<li>opscode chef</li>
<li>chef-client/chef-server</li>
<li>hosted chef (propuesta comercial de opscode)</li>
<li>chef-solo</li>
<li>puppet</li>
<li>cfengine</li>
<li>otros &#8230;.</li>
</ul>


<h3>¿Cual es mejor?</h3>

<ul>
<li>puppet o chef</li>
<li>vi o emacs</li>
<li>ruby o python</li>
<li>linux o windows</li>
</ul>


<p>Con Puppet, un Cron Type sería algo asi:</p>

<figure class='code'><figcaption><span>Puppet Cron Type</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">cron</span> <span class="p">{</span> <span class="n">command</span><span class="p">:</span>
</span><span class='line'>  <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">&quot;/usr/local/sbin/command&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">hour</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>  <span class="n">minute</span> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Con Chef, declarar un Recurso equivalente seria:</p>

<figure class='code'><figcaption><span>chef resource</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">cron</span> <span class="s2">&quot;describe your job&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">hour</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'>  <span class="n">minute</span> <span class="s2">&quot;0&quot;</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;/usr/local/sbin/command&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>modos de trabajo</h3>

<ul>
<li>chef-solo</li>
<li>chef-server</li>
<li>hosted chef</li>
</ul>


<h3>instalación rapida en 3 pasos</h3>

<ul>
<li>instalar ruby</li>
<li>depende del sistema operativo</li>
<li>instalar chef: sudo gem install chef</li>
<li>no hay tercer paso ;)</li>
</ul>


<h3>¿Qué es una receta?</h3>

<ul>
<li>con solo dos archivos ya armamos una receta</li>
<li>en realidad con uno basta (se puede excluir la metadata)</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>foo/recipes/default.rb
</span><span class='line'>foo/metadata.rb
</span></code></pre></td></tr></table></div></figure>


<h3>ejemplo de una receta para PHP</h3>

<figure class='code'><figcaption><span>default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running php recipe)</span>
</span><span class='line'>
</span><span class='line'><span class="s2">package &quot;</span><span class="n">php5</span><span class="o">-</span><span class="n">cgi</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">package &quot;</span><span class="n">php5</span><span class="o">-</span><span class="n">cli</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">package &quot;</span><span class="n">php5</span><span class="o">-</span><span class="n">mysql</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">package &quot;</span><span class="n">php5</span><span class="o">-</span><span class="n">curl</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">package &quot;</span><span class="n">php5</span><span class="o">-</span><span class="n">dev</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s2">include_recipe &quot;</span><span class="n">php</span><span class="o">::</span><span class="n">pear</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ejemplo de una receta para PHP</h3>

<figure class='code'><figcaption><span>pear.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running pear recipe&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;php-pear&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;Update PEAR and all packages&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;pear upgrade-all&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;Install HTTP_Session2 &amp; Net_CheckIP2&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;pear install HTTP_Session2-beta Net_CheckIP-1.0.0RC3&quot;</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;test -f /usr/share/php/pear/HTTP/Session2.php&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ejemplo de una receta para PHP</h3>

<figure class='code'><figcaption><span>metadata.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">maintainer</span>        <span class="s2">&quot;Till Klampeckel&quot;</span>
</span><span class='line'><span class="n">maintainer_email</span>  <span class="s2">&quot;till@php.net&quot;</span>
</span><span class='line'><span class="n">license</span>           <span class="s2">&quot;BSD License&quot;</span>
</span><span class='line'><span class="n">description</span>       <span class="s2">&quot;Install PHP &amp; required dependencies.&quot;</span>
</span><span class='line'><span class="n">version</span>           <span class="s2">&quot;0.1&quot;</span>
</span><span class='line'><span class="n">recipe</span>            <span class="s2">&quot;php::default&quot;</span><span class="p">,</span> <span class="s2">&quot;Install and configure PHP&quot;</span>
</span><span class='line'><span class="n">recipe</span>            <span class="s2">&quot;php::pear&quot;</span><span class="p">,</span> <span class="s2">&quot;Install PEAR and packages&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">supports</span> <span class="s1">&#39;ubuntu&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ejemplo de una receta para PHP</h3>

<p>Estructura del directorio</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/tmp/chef/cookbooks/php/
</span><span class='line'>/tmp/chef/cookbooks/php/metadata.rb
</span><span class='line'>/tmp/chef/cookbooks/php/recipes/default.rb
</span><span class='line'>/tmp/chef/cookbooks/php/recipes/pear.rb
</span></code></pre></td></tr></table></div></figure>


<h3>ejemplo de una receta para PHP</h3>

<p>Utilizando el modo de trabajo Chef-solo</p>

<ul>
<li>Necesitamos dos archivo de configuración</li>
<li>/etc/chef/solo.rb</li>
<li>node.json</li>
<li>Un repositorio de cookbooks</li>
</ul>


<figure class='code'><figcaption><span>/etc/chef/solo.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">file_cache_path</span> <span class="s2">&quot;/tmp/chef&quot;</span>
</span><span class='line'><span class="n">cookbook_path</span> <span class="s2">&quot;/tmp/chef/cookbooks&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ejemplo de una receta para PHP</h3>

<p>node.json</p>

<ul>
<li>JSON qué? la mujer de quién?</li>
<li>La lista de ejecución (run_list) define las recetas que van a ser utilizadas y el orden que son ejecutadas.</li>
</ul>


<figure class='code'><figcaption><span>node.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;run_list&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;recipe[php]&quot;</span> <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Ser flexibles</h3>

<ul>
<li>Mantener las recetas genéricas</li>
<li>Configuración individual</li>
<li>Utilizar variables en node.json</li>
</ul>


<h3>ejemplo de node.json</h3>

<figure class='code'><figcaption><span>node.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;php&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;memory&quot;</span><span class="o">:</span><span class="s2">&quot;18G&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="o">:</span><span class="s2">&quot;/tmp/php/data&quot;</span> <span class="p">},</span>
</span><span class='line'>  <span class="s2">&quot;run_list&quot;</span><span class="o">:</span> <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>uso de variables en foo.rb:</p>

<figure class='code'><figcaption><span>foo.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">memory</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:php</span><span class="o">][</span><span class="ss">:memory</span><span class="o">]</span>
</span><span class='line'><span class="n">tempdir</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:php</span><span class="o">][</span><span class="ss">:tmp</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">directory</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">tempdir</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s2">&quot;www-data&quot;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s2">&quot;www-data&quot;</span>
</span><span class='line'>  <span class="n">recursive</span> <span class="ss">:true</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:delete</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Ejecución</h3>

<p>Con el archivo node.json local en el servidor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chef-solo -j /tmp/node.json <span class="o">[</span>-c /etc/chef/solo.rb<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>El archivo node.json y las recetas se pueden descargar de un servidor remoto [master, Amazon S3,..]:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chef-solo -j http://example.org/node.json -r http://example.org/recipes.tar.gz
</span></code></pre></td></tr></table></div></figure>


<h2>Uso avanzado</h2>

<h3>Archivos</h3>

<ul>
<li>distribución de archivos de configuración</li>
<li>archivos estáticos - solo necesitan ser copiados tal cual</li>
</ul>


<figure class='code'><figcaption><span>openssh/files/default/banner</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="no">Ud</span><span class="o">.</span> <span class="n">est</span><span class="err">á</span> <span class="n">ingresando</span> <span class="n">a</span> <span class="n">una</span> <span class="n">red</span> <span class="n">inform</span><span class="err">á</span><span class="n">tica</span> <span class="n">de</span> <span class="no">Acceso</span> <span class="no">Restringido</span> <span class="n">y</span> <span class="n">que</span> <span class="n">contiene</span> <span class="n">informaci</span><span class="err">ó</span><span class="n">n</span>
</span><span class='line'><span class="n">legalmente</span> <span class="n">protegida</span><span class="p">,</span> <span class="n">confidencial</span> <span class="n">y</span><span class="o">/</span><span class="n">o</span> <span class="n">de</span> <span class="n">secreto</span> <span class="n">profesional</span><span class="p">,</span> <span class="n">cuyo</span> <span class="n">uso</span> <span class="n">indebido</span>
</span><span class='line'><span class="n">puede</span> <span class="n">generar</span> <span class="n">al</span> <span class="n">usuario</span> <span class="n">responsabilidad</span> <span class="n">civil</span> <span class="n">o</span> <span class="n">configurar</span> <span class="n">los</span>
</span><span class='line'><span class="n">delitos</span> <span class="n">previstos</span> <span class="n">en</span> <span class="n">los</span> <span class="n">arts</span><span class="o">.</span> <span class="mi">153</span> <span class="n">a</span> <span class="mi">157</span> <span class="n">del</span> <span class="n">C</span><span class="err">ó</span><span class="n">digo</span> <span class="no">Penal</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>openssh/recipes/default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="c1"># asume openssh/files/default/banner</span>
</span><span class='line'><span class="n">template</span> <span class="s2">&quot;banner&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span>  <span class="s2">&quot;banner&quot;</span>
</span><span class='line'>  <span class="n">owner</span>   <span class="s2">&quot;root&quot;</span>
</span><span class='line'>  <span class="n">group</span>   <span class="s2">&quot;root&quot;</span>
</span><span class='line'>  <span class="n">mode</span>    <span class="s2">&quot;0644&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Atributos</h3>

<ul>
<li>los atributos de un node son generados por ohai</li>
<li>pueden ser modificados ó adicionados en las recetas de los cookbooks, en los roles o los ambientes</li>
<li>ejemplo de atributos en una receta (openssh/attributes/default.rb):</li>
</ul>


<figure class='code'><figcaption><span>openssh/attributes/default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">default</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:port</span><span class="o">]</span>                <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;22&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:listen_address</span><span class="o">]</span>      <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;0.0.0.0&quot;</span> <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:permit_root_login</span><span class="o">]</span>   <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:x11_forwarding</span><span class="o">]</span>      <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:ignore_rhosts</span><span class="o">]</span>      <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:use_dns</span><span class="o">]</span>      <span class="o">=</span> <span class="s2">&quot;no&quot;</span>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:banner</span><span class="o">]</span>      <span class="o">=</span> <span class="s2">&quot;/etc/ssh/banner&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>ejemplo de atributos en un ambiente</li>
</ul>


<figure class='code'><figcaption><span>roles/local.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">name</span> <span class="s2">&quot;local&quot;</span>
</span><span class='line'><span class="n">description</span> <span class="s2">&quot;local testing environment&quot;</span>
</span><span class='line'><span class="n">override_attributes</span> <span class="p">({</span>
</span><span class='line'>    <span class="s2">&quot;ntp&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;ntp_server&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;time.apple.com&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Plantillas</h3>

<ul>
<li>Archivos de configuración</li>
<li>Scripts de inicio</li>
<li>uso de atributos en una plantilla (openssh/templates/centos/sshd_config.erb):</li>
</ul>


<figure class='code'><figcaption><span>openssh/templates/centos/sshd_config.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="no">PermitRootLogin</span> <span class="o">&lt;</span><span class="sx">%= node[:openssh][:permit_root_login] %&gt;</span>
</span><span class='line'><span class="sx">IgnoreRhosts &lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:ignore_rhosts</span><span class="o">]</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">X11Forwarding &lt;%= node[:openssh][:x11_forwarding] %&gt;</span>
</span><span class='line'><span class="no">Banner</span>  <span class="o">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:openssh</span><span class="o">][</span><span class="ss">:banner</span><span class="o">]</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>uso de una plantilla en una receta (openssh/recipes/default.rb):</li>
</ul>


<figure class='code'><figcaption><span>openssh/recipes/default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">template</span> <span class="s2">&quot;/etc/ssh/sshd_config&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">source</span>  <span class="s2">&quot;sshd_config.erb&quot;</span>
</span><span class='line'>    <span class="n">owner</span>   <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="n">group</span>   <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="n">mode</span>    <span class="s2">&quot;0600&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[sshd]&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[instalacion de un server de ci]]></title>
    <link href="http://devops-ar.github.com/blog/2011/11/30/instalacion-de-un-server-de-ci/"/>
    <updated>2011-11-30T14:26:00-03:00</updated>
    <id>http://devops-ar.github.com/blog/2011/11/30/instalacion-de-un-server-de-ci</id>
    <content type="html"><![CDATA[<p>CI - Continuous Integration.</p>

<p>Este post describe la instalación de un servidor de integración continua. El mismo estará integrado por jenkins, maven y sonar.</p>

<h1>jenkins</h1>

<h2>Instalacion de jenkins</h2>

<p>Esta instalacion describe la instalacion de jenkins en un container tomcat ya existente y utilizando al apache (via mod_proxy_ajp) como frontend.</p>

<p>jenkins es un fork de hudson.</p>

<p>La instalacion se realiza sobre un server estandar con tomcat instalado.</p>

<p>Los pasos a realizar serian los siguientes:
* Descargar la ultima version del war de jenkins (el ejemplo es para el caso de server).
* Configurar el apache.
* Reiniciar el apache y el tomcat.</p>

<h2>Descargar el jenkins.</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>wget -P /opt/thirdparty/tomcat/webapps/ http://updates.jenkins-ci.org/download/war/1.438/jenkins.war
</span></code></pre></td></tr></table></div></figure>


<h2>Configurar el apache</h2>

<p>Primero revisar que el modulo este activado. En el archivo /etc/httpd/conf.d/proxy_ajp.conf la siguiente linea este descomentareada.</p>

<p>LoadModule proxy_ajp_module modules/mod_proxy_ajp.so</p>

<p>Nota: Asegurarse de que el modulo mod_jk no este habilitado (usualmente el archivo mod_jk.conf en el mismo directorio).</p>

<p>Luego se crea un archivo de virtualhost para el server.</p>

<figure class='code'><figcaption><span>/etc/httpd/vhost.d/server.conf </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nb">ProxyRequests</span> <span class="k">Off</span>
</span><span class='line'><span class="nb">ProxyPreserveHost</span> <span class="k">On</span>
</span><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">*:80</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">ServerAdmin</span> unixadmin@example.com
</span><span class='line'>    <span class="nb">ServerName</span> server.example.com
</span><span class='line'>    <span class="nb">ProxyPass</span> <span class="sx">/sonar</span> ajp://localhost:9009/sonar
</span><span class='line'>    <span class="c">#ProxyPass /nexus http://localhost:8081/nexus</span>
</span><span class='line'>    <span class="c">#ProxyPassReverse /nexus http://localhost:8081/nexus</span>
</span><span class='line'>    <span class="nb">ProxyPass</span> /   ajp://localhost:8009/
</span><span class='line'>    <span class="nb">ErrorLog</span> logs/server.dev.corp-error_log
</span><span class='line'>    <span class="nb">CustomLog</span> logs/server.dev.corp-access_log common
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nota, las lineas para el sonar y el nexus solo se requieren si estos servicios van a ser instalados, si no, se dejan comentadas.</p>

<p>Se habilita el puerto 8009 para el protocolo AJP en el tomcat (por defecto solo habilita el 8080: protocolo HTTP).</p>

<figure class='code'><figcaption><span>/opt/thirdparty/tomcat/conf/server.xml </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span>
</span><span class='line'><span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">&quot;8009&quot;</span> <span class="na">protocol=</span><span class="s">&quot;AJP/1.3&quot;</span> <span class="na">redirectPort=</span><span class="s">&quot;8443&quot;</span> <span class="na">URIEncoding=</span><span class="s">&quot;UTF-8&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y se reinician el apache y el tomcat</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/etc/init.d/httpd restart
</span><span class='line'>/etc/init.d/tomcat stop
</span><span class='line'>/etc/init.d/tomcat start
</span></code></pre></td></tr></table></div></figure>


<p>El jenkins deberia estar accesible en: http://server.example.com/jenkins</p>

<p>Se sugiere crear una pagina de inicio por si alguien teclea la url http://server.example.com/ directamente.
Esta pagina se crea en
$CATALINA_HOME/webapps/ROOT/index.html</p>

<p>Por ejemplo:</p>

<figure class='code'><figcaption><span>/opt/thirdparty/tomcat/webapps/ROOT/index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;&lt;title&gt;</span>server <span class="nt">&lt;/title&gt;</span> <span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>server<span class="nt">&lt;p</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;ul&gt;</span>
</span><span class='line'><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/jenkins&quot;</span><span class="nt">&gt;</span>jenkins<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/sonar&quot;</span><span class="nt">&gt;</span>sonar<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/nexus&quot;</span><span class="nt">&gt;</span>nexus<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="nt">&lt;/ul&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Maven</h1>

<p>Descargar y descompactar el maven.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>wget -P /opt/thirdparty http://apache.dattatec.com//maven/binaries/apache-maven-3.0.3-bin.tar.gz
</span><span class='line'><span class="nb">cd</span> /opt/thirdparty
</span><span class='line'>tar zxf apache-maven-3.0.3-bin.tar.gz
</span><span class='line'>rm apache-maven-3.0.3-bin.tar.gz
</span><span class='line'>ln -s apache-maven-3.0.3 maven
</span></code></pre></td></tr></table></div></figure>


<p>Adicionar al final del archivo /etc/bashrc las siguientes lineas</p>

<figure class='code'><figcaption><span>/etc/bashrc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/opt/thirdparty/java
</span><span class='line'><span class="nb">export </span><span class="nv">M2_HOME</span><span class="o">=</span>/opt/thirdparty/maven
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">M2_HOME</span><span class="k">}</span>/bin:<span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Si nuestro server utiliza un proxy para conectarse a la web, deberemos configurar el maven para hacer uso de este proxy.  Esto se hace en el archivo de configuracion del maven: /opt/thirdparty/maven/conf/settings.xml donde la seccion de proxies deberá quedar de la siguiente manera:</p>

<figure class='code'><figcaption><span>/opt/thirdparty/maven/conf/settings.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;proxies&gt;</span>
</span><span class='line'>   <span class="nt">&lt;proxy&gt;</span>
</span><span class='line'>      <span class="nt">&lt;active&gt;</span>true<span class="nt">&lt;/active&gt;</span>
</span><span class='line'>      <span class="nt">&lt;protocol&gt;</span>http<span class="nt">&lt;/protocol&gt;</span>
</span><span class='line'>      <span class="nt">&lt;host&gt;</span>proxy.example.com<span class="nt">&lt;/host&gt;</span>
</span><span class='line'>      <span class="nt">&lt;port&gt;</span>3128<span class="nt">&lt;/port&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/proxy&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/proxies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Sonar</h1>

<p>Descargamos el sonar y lo descompactamos en un directorio.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">COMPANY</span><span class="o">=</span>globant
</span><span class='line'><span class="nb">cd</span> /opt/<span class="nv">$COMPANY</span>
</span><span class='line'>wget http://dist.sonar.codehaus.org/sonar-2.11.zip
</span><span class='line'>unzip sonar-2.11.zip
</span><span class='line'>ln -s sonar-2.11 sonar
</span><span class='line'>rm -f sonar-2.11.zip
</span></code></pre></td></tr></table></div></figure>


<h2>Creamos la base de datos</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">sonar</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8</span><span class="err">\</span><span class="n">_general_ci</span><span class="p">;</span>
</span><span class='line'><span class="k">grant</span> <span class="k">all</span> <span class="k">privileges</span> <span class="k">on</span> <span class="n">sonar</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">&#39;sonar&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">&#39;Ht4uS1cNwbxeI&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">flush</span> <span class="k">privileges</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Se declara la base de datos en el archivo de propiedades del sonar: /opt/thirdparty/sonar/conf/sonar.properties</p>

<figure class='code'><figcaption><span>/opt/thirdparty/sonar/conf/sonar.properties</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">sonar.web.host</span><span class="o">:</span>                           <span class="s">0.0.0.0</span>
</span><span class='line'><span class="na">sonar.web.port</span><span class="o">:</span>                           <span class="s">9000</span>
</span><span class='line'><span class="na">sonar.web.context</span><span class="o">:</span>                        <span class="s">/sonar</span>
</span><span class='line'><span class="c">#sonar.web.context:                        /</span>
</span><span class='line'><span class="na">sonar.ajp13.port</span><span class="o">:</span> <span class="s">9009</span>
</span><span class='line'>
</span><span class='line'><span class="na">sonar.jdbc.username</span><span class="o">:</span>                       <span class="s">sonar</span>
</span><span class='line'><span class="na">sonar.jdbc.password</span><span class="o">:</span>                       <span class="s">*********</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Comment the following lines to deactivate the default embedded database.</span>
</span><span class='line'><span class="c">#sonar.jdbc.url:                            jdbc:derby://localhost:1527/sonar;create=true</span>
</span><span class='line'><span class="c">#sonar.jdbc.driverClassName:                org.apache.derby.jdbc.ClientDriver</span>
</span><span class='line'><span class="c">#sonar.jdbc.validationQuery:                values(1)</span>
</span><span class='line'>
</span><span class='line'><span class="na">sonar.jdbc.url</span><span class="o">:</span> <span class="s">jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8</span>
</span><span class='line'><span class="na">sonar.jdbc.driverClassName</span><span class="o">:</span> <span class="s">com.mysql.jdbc.Driver</span>
</span><span class='line'><span class="na">sonar.jdbc.validationQuery</span><span class="o">:</span> <span class="s">select 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Podemos iniciar el sonar manualmente.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$SONAR_HOME</span>/bin/linux-x86-32/sonar.sh start
</span></code></pre></td></tr></table></div></figure>


<p>Y comprobar que funciona accediendo al puerto 9000 del server: <a href="http://server.example.com:9000/">http://server.example.com:9000/</a></p>

<p>Adicionamos una instalacion de sonar al jenkins</p>

<p>Si el server soporta la instalación de plugins via web.
<a href="http://server.example.com/jenkins/pluginManager/available">http://server.example.com/jenkins/pluginManager/available</a></p>

<p>Instalando el plugin de sonar manualmente.
<a href="http://updates.jenkins-ci.org/download/plugins/">http://updates.jenkins-ci.org/download/plugins/</a></p>

<p>Descargamos el archivo *.hpi para el directorio $JENKINS_HOME/plugins directory. Algunos contenedores podrian requerir reiniciar Jenkins para que muestre el nuevo plugin.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> <span class="nv">$TOMCAT_HOME</span>/webapps/jenkins/WEB-INF/plugins
</span><span class='line'>wget http://updates.jenkins-ci.org/latest/sonar.hpi
</span><span class='line'>chown tomcat:tomcat sonar.hpi
</span></code></pre></td></tr></table></div></figure>


<p>Configuramos jenkins para que utilice el sonar: <a href="http://server.example.com:8080/jenkins/configure">http://server.example.com:8080/jenkins/configure</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="err">Name</span>  <span class="err">sonar</span>
</span><span class='line'><span class="na">Server URL   http</span><span class="o">:</span><span class="s">//server.example.com/sonar</span>
</span><span class='line'><span class="na">Database URL     jdbc</span><span class="o">:</span><span class="s">mysql://localhost:3306/sonar?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8</span>
</span><span class='line'><span class="err">Database</span> <span class="err">login</span>  <span class="err">sonar</span>
</span><span class='line'><span class="err">Database</span> <span class="err">password</span>   <span class="err">&lt;el</span> <span class="err">mismo</span> <span class="err">que</span> <span class="err">utilizamos</span> <span class="err">para</span> <span class="err">la</span> <span class="err">creacion</span> <span class="err">del</span> <span class="err">usuario</span> <span class="err">mysql&gt;</span>
</span><span class='line'><span class="err">Database</span> <span class="err">driver</span> <span class="err">com.mysql.jdbc.Driver</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Referencias</h1>

<h2>Jenkins</h2>

<ul>
<li><a href="https://wiki.jenkins-ci.org/display/JENKINS/Plugins">https://wiki.jenkins-ci.org/display/JENKINS/Plugins</a></li>
</ul>


<h2>Sonar</h2>

<ul>
<li><a href="http://docs.codehaus.org/display/SONAR/Configure+Sonar+plugin">http://docs.codehaus.org/display/SONAR/Configure+Sonar+plugin</a></li>
<li><a href="http://www.wakaleo.com/component/content/article/187">http://www.wakaleo.com/component/content/article/187</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
